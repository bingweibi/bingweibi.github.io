<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Glide," />










<meta name="description" content="一篇分析主流图片加载框架很好的文章 本系列文章是在郭霖的文章基础上进行写作的 在使用Glide的时候我们经常就下面的一句语句就完成了图片加载的工作，那么你是否知道里面究竟发生了什么事情？ 1Glide.with(context).load(URL).into(ImageView);">
<meta name="keywords" content="Glide">
<meta property="og:type" content="article">
<meta property="og:title" content="Glide-1">
<meta property="og:url" content="http://yoursite.com/2018/07/20/Glide-1/index.html">
<meta property="og:site_name" content="Wakaka">
<meta property="og:description" content="一篇分析主流图片加载框架很好的文章 本系列文章是在郭霖的文章基础上进行写作的 在使用Glide的时候我们经常就下面的一句语句就完成了图片加载的工作，那么你是否知道里面究竟发生了什么事情？ 1Glide.with(context).load(URL).into(ImageView);">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-07-20T09:22:38.454Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Glide-1">
<meta name="twitter:description" content="一篇分析主流图片加载框架很好的文章 本系列文章是在郭霖的文章基础上进行写作的 在使用Glide的时候我们经常就下面的一句语句就完成了图片加载的工作，那么你是否知道里面究竟发生了什么事情？ 1Glide.with(context).load(URL).into(ImageView);">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/07/20/Glide-1/"/>





  <title>Glide-1 | Wakaka</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	
	<a href="https://github.com/bingweibi">
	<img style="position: absolute; top: 0; right: 0; border: 0;" 
	src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" 
	alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wakaka</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">路漫漫其修远兮，吾将上下而求索</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/20/Glide-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wakaka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wakaka">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Glide-1</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-20T11:10:05+08:00">
                2018-07-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="http://www.trinea.cn/android/android-image-cache-compare/" target="_blank" rel="noopener">一篇分析主流图片加载框架很好的文章</a></p>
<p>本系列文章是在<a href="https://blog.csdn.net/guolin_blog/article/details/53939176" target="_blank" rel="noopener">郭霖</a>的文章基础上进行写作的</p>
<p>在使用Glide的时候我们经常就下面的一句语句就完成了图片加载的工作，那么你是否知道里面究竟发生了什么事情？</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Glide</span><span class="selector-class">.with</span>(<span class="selector-tag">context</span>)<span class="selector-class">.load</span>(<span class="selector-tag">URL</span>)<span class="selector-class">.into</span>(<span class="selector-tag">ImageView</span>);</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="with"><a href="#with" class="headerlink" title="with()"></a>with()</h1><p>Glide开始于with()。传递的参数可以是Context、Activity、Fragment(方法重载),返回的是RequestManager，load()就是从它开始的。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> RequestManager <span class="keyword">with</span>(Context <span class="keyword">context</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> getRetriever(<span class="keyword">context</span>)<span class="variable">.get</span>(<span class="keyword">context</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当参数是Context的时候，这时候Glide就可以通过这个参数得应用的生命周期，应用程序关闭的话，Gli停止加载。</li>
<li>当参数是Activity/Fragment的时候，会向当前的Activity当中添加一个隐藏的Fragment，因为Fragment的生命周期和Activity同步，如果Activity被销毁的时候，添加的Fragment可以监听到，这样Glide就会捕获这个事件并停止加载事件。</li>
</ul>
<p>with()其实就是为了得到一个RequestManager对象，然后Glide会根据我们传入with()方法的参数来确定图片加载的生命周期</p>
<p>返回的是RequestManager，用于第二个过程load()的开始。</p>
<h1 id="load"><a href="#load" class="headerlink" title="load()"></a>load()</h1><p>Glide是支持图片URL字符串、Bitmap、Drawable、Uri 、File、resourceId等加载形式的，因此RequestManager中也有很多个load()方法的重载。</p>
<p>下面以加载URL字符串的load()方法进行研究</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> ,<span class="title">ModelTypes</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">Drawable</span>&gt;&gt;&#123;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Equivalent to calling &#123;<span class="doctag">@link</span> #asDrawable()&#125; and then &#123;<span class="doctag">@link</span> RequestBuilder#load(String)&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A new request builder for loading a &#123;<span class="doctag">@link</span> Drawable&#125; using the given model.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; load(<span class="meta">@Nullable</span> String string) &#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="load-方法"><a href="#load-方法" class="headerlink" title="load()方法"></a>load()方法</h2><ul>
<li>先调用了asDrawable()方法</li>
<li>再调用load()方法</li>
<li>然后把传入的图片URL地址传进去。</li>
</ul>
<p>asDrawable()方法返回的是 RequestBuilder，建立请求</p>
<h2 id="loadGeneric-方法"><a href="#loadGeneric-方法" class="headerlink" title="loadGeneric()方法"></a>loadGeneric()方法</h2><p>load()源码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a request builder to load the given &#123;<span class="doctag">@link</span> java.lang.String&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Note - this method caches data using only the given String as the cache key. If the data is</span></span><br><span class="line"><span class="comment"> * a Uri outside of your control, or you otherwise expect the data represented by the given String</span></span><br><span class="line"><span class="comment"> * to change without the String identifier changing, Consider using</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> com.bumptech.glide.request.RequestOptions#signature(com.bumptech.glide.load.Key)&#125; to</span></span><br><span class="line"><span class="comment"> * mixin a signature you create that identifies the data currently at the given String that will</span></span><br><span class="line"><span class="comment"> * invalidate the cache if that data changes. Alternatively, using</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> com.bumptech.glide.load.engine.DiskCacheStrategy#NONE&#125; and/or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> com.bumptech.glide.request.RequestOptions#skipMemoryCache(boolean)&#125; may be</span></span><br><span class="line"><span class="comment"> * appropriate.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #load(Object)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string A file path, or a uri or url handled by</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> com.bumptech.glide.load.model.UriLoader&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@CheckResult</span></span><br><span class="line"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; load(<span class="meta">@Nullable</span> String string) &#123;</span><br><span class="line">  <span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; loadGeneric(<span class="meta">@Nullable</span> Object model) &#123;</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  isModelSet = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>loadGeneric()方法是要返回一个RequestBuilder对象的，因此在loadGeneric()方法的最后<code>return this</code>，然后把string –&gt; model对象.</p>
<h2 id="RequestManager源码"><a href="#RequestManager源码" class="headerlink" title="RequestManager源码"></a>RequestManager源码</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Attempts to always load the resource as a &#123;<span class="doctag">@link</span> android.graphics.Bitmap&#125;, even if it could</span></span><br><span class="line"><span class="comment">   * actually be animated.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A new request builder for loading a &#123;<span class="doctag">@link</span> android.graphics.Bitmap&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="keyword">public</span> RequestBuilder&lt;Bitmap&gt; asBitmap() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">as</span>(Bitmap.<span class="keyword">class</span>).apply(DECODE_TYPE_BITMAP);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Attempts to always load the resource as a</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> com.bumptech.glide.load.resource.gif.GifDrawable&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt; If the underlying data is not a GIF, this will fail. As a result, this should only be used</span></span><br><span class="line"><span class="comment">   * if the model represents an animated GIF and the caller wants to interact with the GifDrawable</span></span><br><span class="line"><span class="comment">   * directly. Normally using just &#123;<span class="doctag">@link</span> #asDrawable()&#125; is sufficient because it will determine</span></span><br><span class="line"><span class="comment">   * whether or not the given data represents an animated GIF and return the appropriate &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">   * Drawable&#125;, animated or not, automatically. &lt;/p&gt;</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 不是Gif会报错</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A new request builder for loading a</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> com.bumptech.glide.load.resource.gif.GifDrawable&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="keyword">public</span> RequestBuilder&lt;GifDrawable&gt; asGif() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">as</span>(GifDrawable.<span class="keyword">class</span>).apply(DECODE_TYPE_GIF);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它提供了asBitmap()和asGif()这两个方法，分别是用于强制指定加载静态图片和动态图片。</p>
<h2 id="RequestBuilder"><a href="#RequestBuilder" class="headerlink" title="RequestBuilder"></a>RequestBuilder</h2><p>我们再回到RequestManager的load()方法中。我们来看下<code>RequestBuilder</code>这个类的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span>,</span></span><br><span class="line"><span class="class">    <span class="title">ModelTypes</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">RequestBuilder</span><span class="params">(Class&lt;TranscodeType&gt; transcodeClass, RequestBuilder&lt;?&gt; other)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">apply</span><span class="params">(@NonNull RequestOptions requestOptions)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We're checking to see if we need to clone our options object because we want to make sure the</span></span><br><span class="line">  <span class="comment">// original is never modified, so we need reference equality.</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"ReferenceEquality"</span>)</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> RequestOptions <span class="title">getMutableOptions</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">transition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">listener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestListener&lt;TranscodeType&gt; requestListener)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">error</span><span class="params">(@Nullable RequestBuilder&lt;TranscodeType&gt; errorBuilder)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">thumbnail</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestBuilder&lt;TranscodeType&gt; thumbnailRequest)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"CheckResult"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">thumbnail</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestBuilder&lt;TranscodeType&gt;... thumbnails)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">thumbnail</span><span class="params">(<span class="keyword">float</span> sizeMultiplier)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable Object model)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable Bitmap bitmap)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable Drawable drawable)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable Uri uri)</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable File file)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@RawRes @DrawableRes @Nullable Integer resourceId)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Deprecated</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable URL url)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable <span class="keyword">byte</span>[] model)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(&#123;</span><br><span class="line">      <span class="string">"unchecked"</span>,</span><br><span class="line">      <span class="comment">// we don't want to throw to be user friendly</span></span><br><span class="line">      <span class="string">"PMD.CloneThrowsCloneNotSupportedException"</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">clone</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">public</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(@NonNull Y target)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull RequestOptions options)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSkipMemoryCacheWithCompletePreviousRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      RequestOptions options, Request previous)</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Deprecated</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FutureTarget&lt;TranscodeType&gt; <span class="title">into</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FutureTarget&lt;TranscodeType&gt; <span class="title">submit</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FutureTarget&lt;TranscodeType&gt; <span class="title">submit</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Target&lt;TranscodeType&gt; <span class="title">preload</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Target&lt;TranscodeType&gt; <span class="title">preload</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Deprecated</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="keyword">public</span> &lt;Y extends Target&lt;File&gt;&gt; <span class="function">Y <span class="title">downloadOnly</span><span class="params">(@NonNull Y target)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Deprecated</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FutureTarget&lt;File&gt; <span class="title">downloadOnly</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> RequestBuilder&lt;File&gt; <span class="title">getDownloadOnlyRequest</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Priority <span class="title">getThumbnailPriority</span><span class="params">(@NonNull Priority current)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Request <span class="title">buildRequest</span><span class="params">(&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>为了节省篇幅，只留下了方法名，去除了方法体。RequestBuilder中有很多个方法，这些方法其实就是Glide绝大多数的API了。</p>
<p>你会发现RequestBuilder类中有into()方法，也就是说，最终load()方法返回的其实就是一个DrawableTypeRequest对象？？？。那么接下来我们就要进行第三步了，分析into()方法中的逻辑。</p>
<h1 id="into"><a href="#into" class="headerlink" title="into()"></a>into()</h1><p>into()方法的具体逻辑都是在RequestBuilder的父类当中了。</p>
<h2 id="RequestBuilder中的into-方法"><a href="#RequestBuilder中的into-方法" class="headerlink" title="RequestBuilder中的into()方法"></a>RequestBuilder中的into()方法</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sets the &#123;<span class="doctag">@link</span> ImageView&#125; the resource will be loaded into, cancels any existing loads into</span></span><br><span class="line"><span class="comment">   * the view, and frees any resources Glide may have previously loaded into the view so they may be</span></span><br><span class="line"><span class="comment">   * reused.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see</span> RequestManager#clear(Target)</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> view The view to cancel previous loads for and load the new resource into.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> com.bumptech.glide.request.target.Target&#125; used to wrap the given &#123;<span class="doctag">@link</span> ImageView&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; into(<span class="meta">@NonNull</span> ImageView view) &#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line">    Preconditions.checkNotNull(view);</span><br><span class="line"></span><br><span class="line">    RequestOptions requestOptions = <span class="keyword">this</span>.requestOptions;</span><br><span class="line">    <span class="keyword">if</span> (!requestOptions.isTransformationSet()</span><br><span class="line">        &amp;&amp; requestOptions.isTransformationAllowed()</span><br><span class="line">        &amp;&amp; view.getScaleType() != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Clone in this method so that if we use this RequestBuilder to load into a View and then</span></span><br><span class="line">      <span class="comment">// into a different target, we don't retain the transformation applied based on the previous</span></span><br><span class="line">      <span class="comment">// View's scale type.</span></span><br><span class="line">      <span class="keyword">switch</span> (view.getScaleType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">CENTER_CROP:</span></span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterCrop();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">CENTER_INSIDE:</span></span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">FIT_CENTER:</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">FIT_START:</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">FIT_END:</span></span><br><span class="line">          requestOptions = requestOptions.clone().optionalFitCenter();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">FIT_XY:</span></span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">CENTER:</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">MATRIX:</span></span><br><span class="line"><span class="symbol">        default:</span></span><br><span class="line">          <span class="comment">// Do nothing.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> into(</span><br><span class="line">        glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">        <span class="comment">/*targetListener=*/</span> <span class="literal">null</span>,</span><br><span class="line">        requestOptions);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>现在我们只需要关注最后一行代码。最后一行代码先是调用了glideContext.buildImageViewTarget()方法，这个方法会构建出一个Target对象。</p>
<p>Target对象则是用来最终展示图片用的，源码如下：</p>
<h3 id="buildImageViewTarget"><a href="#buildImageViewTarget" class="headerlink" title="buildImageViewTarget"></a>buildImageViewTarget</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">R</span>&gt;</span> Target<span class="tag">&lt;<span class="name">R</span>&gt;</span> buildImageViewTarget(ImageView imageView, Class<span class="tag">&lt;<span class="name">R</span>&gt;</span> transcodedClass) &#123;</span><br><span class="line">    return imageViewTargetFactory.buildTarget(imageView, transcodedClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里其实又是调用了ImageViewTargetFactory的buildTarget()方法</p>
<h3 id="ImageViewTargetFactory"><a href="#ImageViewTargetFactory" class="headerlink" title="ImageViewTargetFactory"></a>ImageViewTargetFactory</h3><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> ImageViewTargetFactory &#123;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">    public &lt;Z&gt; Target&lt;Z&gt; buildTarget(ImageView <span class="keyword">view</span>, <span class="keyword">Class</span>&lt;Z&gt; clazz) &#123;</span><br><span class="line">        <span class="keyword">if</span> (GlideDrawable.<span class="keyword">class</span>.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Target&lt;Z&gt;) <span class="keyword">new</span> GlideDrawableImageViewTarget(<span class="keyword">view</span>)<span class="comment">;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Bitmap.<span class="keyword">class</span>.equals(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Target&lt;Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(<span class="keyword">view</span>)<span class="comment">;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Drawable.<span class="keyword">class</span>.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Target&lt;Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(<span class="keyword">view</span>)<span class="comment">;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unhandled class: "</span> + clazz</span><br><span class="line">                    + <span class="string">", try .as*(Class).transcode(ResourceTranscoder)"</span>)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在buildTarget()方法中会根据传入的class参数来构建不同的Target对象。</p>
<p>这个class参数其实基本上只有两种情况，如果你在使用Glide加载图片的时候调用了asBitmap()方法，那么这里就会构建出BitmapImageViewTarget对象</p>
<p>否则的话构建的都是GlideDrawableImageViewTarget对象。至于上述代码中的DrawableImageViewTarget对象，这个通常都是用不到的，我们可以暂时不用管它。</p>
<p>通过glide.buildImageViewTarget()方法，我们构建出了一个GlideDrawableImageViewTarget对象。</p>
<p>现在回到刚才into()方法的最后一行，可以看到，这里又将这个参数传入到了GenericRequestBuilder另一个接收Target对象的into()方法当中了。我们来看一下这个into()方法的源码：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;Y <span class="keyword">extends</span> Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(Y <span class="keyword">target</span>)</span> </span>&#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">target</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must pass in a non null Target"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must first set a model (try #load())"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Request previous = <span class="keyword">target</span>.getRequest();</span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">        previous.clear();</span><br><span class="line">        requestTracker.removeRequest(previous);</span><br><span class="line">        previous.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    Request request = buildRequest(<span class="keyword">target</span>);</span><br><span class="line">    <span class="keyword">target</span>.setRequest(request);</span><br><span class="line">    lifecycle.addListener(<span class="keyword">target</span>);</span><br><span class="line">    requestTracker.runRequest(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">target</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第15行调用buildRequest()方法构建出了一个Request对象，还有第18行来执行这个Request。</p>
<p>Request是用来发出加载图片请求的，它是Glide中非常关键的一个组件。我们先来看buildRequest()方法是如何构建Request对象的：</p>
<h3 id="buildRequest"><a href="#buildRequest" class="headerlink" title="buildRequest"></a>buildRequest</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Request buildRequest(</span><br><span class="line">     Target&lt;TranscodeType&gt; <span class="keyword">target</span>,</span><br><span class="line">     <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span><br><span class="line">     RequestOptions requestOptions) &#123;</span><br><span class="line">   <span class="keyword">return</span> buildRequestRecursive(</span><br><span class="line">       <span class="keyword">target</span>,</span><br><span class="line">       targetListener,</span><br><span class="line">       <span class="comment">/*parentCoordinator=*/</span> <span class="keyword">null</span>,</span><br><span class="line">       transitionOptions,</span><br><span class="line">       requestOptions.getPriority(),</span><br><span class="line">       requestOptions.getOverrideWidth(),</span><br><span class="line">       requestOptions.getOverrideHeight(),</span><br><span class="line">       requestOptions);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">private</span> Request buildRequestRecursive(</span><br><span class="line">     Target&lt;TranscodeType&gt; <span class="keyword">target</span>,</span><br><span class="line">     <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span><br><span class="line">     <span class="meta">@Nullable</span> RequestCoordinator parentCoordinator,</span><br><span class="line">     TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span><br><span class="line">     Priority priority,</span><br><span class="line">     <span class="keyword">int</span> overrideWidth,</span><br><span class="line">     <span class="keyword">int</span> overrideHeight,</span><br><span class="line">     RequestOptions requestOptions) &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span></span><br><span class="line">   ErrorRequestCoordinator errorRequestCoordinator = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (errorBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">     errorRequestCoordinator = <span class="keyword">new</span> ErrorRequestCoordinator(parentCoordinator);</span><br><span class="line">     parentCoordinator = errorRequestCoordinator;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Request mainRequest =</span><br><span class="line">       buildThumbnailRequestRecursive(</span><br><span class="line">           <span class="keyword">target</span>,</span><br><span class="line">           targetListener,</span><br><span class="line">           parentCoordinator,</span><br><span class="line">           transitionOptions,</span><br><span class="line">           priority,</span><br><span class="line">           overrideWidth,</span><br><span class="line">           overrideHeight,</span><br><span class="line">           requestOptions);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> mainRequest;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> errorOverrideWidth = errorBuilder.requestOptions.getOverrideWidth();</span><br><span class="line">   <span class="keyword">int</span> errorOverrideHeight = errorBuilder.requestOptions.getOverrideHeight();</span><br><span class="line">   <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)</span><br><span class="line">       &amp;&amp; !errorBuilder.requestOptions.isValidOverride()) &#123;</span><br><span class="line">     errorOverrideWidth = requestOptions.getOverrideWidth();</span><br><span class="line">     errorOverrideHeight = requestOptions.getOverrideHeight();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Request errorRequest = errorBuilder.buildRequestRecursive(</span><br><span class="line">       <span class="keyword">target</span>,</span><br><span class="line">       targetListener,</span><br><span class="line">       errorRequestCoordinator,</span><br><span class="line">       errorBuilder.transitionOptions,</span><br><span class="line">       errorBuilder.requestOptions.getPriority(),</span><br><span class="line">       errorOverrideWidth,</span><br><span class="line">       errorOverrideHeight,</span><br><span class="line">       errorBuilder.requestOptions);</span><br><span class="line">   errorRequestCoordinator.setRequests(mainRequest, errorRequest);</span><br><span class="line">   <span class="keyword">return</span> errorRequestCoordinator;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>buildRequest()方法的内部其实又调用了buildRequestRecursive()方法</p>
<p>buildRequestRecursive()方法中的代码都是在处理缩略图的。</p>
<p>如果我们只追主线流程的话，其实这里都是处理一些像placeholderId、errorPlaceholder、diskCacheStrategy。因此，我们就有理由猜测，刚才在load()方法中调用的所有API，其实都是在这里组装到Request对象当中的。上面的buildRequestRecursive()又接连的调用了下面的方法</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">private Request buildThumbnailRequestRecursive(</span><br><span class="line">      Target&lt;TranscodeType&gt; target,</span><br><span class="line">      RequestListener&lt;TranscodeType&gt; targetListener,</span><br><span class="line">      @Nullable RequestCoordinator parentCoordinator,</span><br><span class="line">      TransitionOptions&lt;?, ? super TranscodeType&gt; transitionOptions,</span><br><span class="line">      Priority priority,</span><br><span class="line">      int overrideWidth,</span><br><span class="line">      int overrideHeight,</span><br><span class="line">      RequestOptions requestOptions) &#123;</span><br><span class="line">    if (thumbnailBuilder != null) &#123;</span><br><span class="line"><span class="symbol">      // Recursive case:</span> contains <span class="literal">a</span> potentially recursive thumbnail request builder.</span><br><span class="line">      if (isThumbnailBuilt) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"You cannot use a request as both the main request and a "</span></span><br><span class="line">            + <span class="string">"thumbnail, consider using clone() on the request(s) passed to thumbnail()"</span>)<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      TransitionOptions&lt;?, ? super TranscodeType&gt; thumbTransitionOptions =</span><br><span class="line">          thumbnailBuilder.transitionOptions<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">      // Apply our transition by default to thumbnail requests but avoid overriding custom options</span><br><span class="line">      // that may have been applied on the thumbnail request explicitly.</span><br><span class="line">      if (thumbnailBuilder.isDefaultTransitionOptionsSet) &#123;</span><br><span class="line">        thumbTransitionOptions = transitionOptions<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Priority thumbPriority = thumbnailBuilder.requestOptions.isPrioritySet()</span><br><span class="line"><span class="symbol">          ? thumbnailBuilder.requestOptions.getPriority() :</span> getThumbnailPriority(priority)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">      int thumbOverrideWidth = thumbnailBuilder.requestOptions.getOverrideWidth()<span class="comment">;</span></span><br><span class="line">      int thumbOverrideHeight = thumbnailBuilder.requestOptions.getOverrideHeight()<span class="comment">;</span></span><br><span class="line">      if (Util.isValidDimensions(overrideWidth, overrideHeight)</span><br><span class="line">          &amp;&amp; !thumbnailBuilder.requestOptions.isValidOverride()) &#123;</span><br><span class="line">        thumbOverrideWidth = requestOptions.getOverrideWidth()<span class="comment">;</span></span><br><span class="line">        thumbOverrideHeight = requestOptions.getOverrideHeight()<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ThumbnailRequestCoordinator coordinator = <span class="keyword">new</span> ThumbnailRequestCoordinator(parentCoordinator)<span class="comment">;</span></span><br><span class="line">      Request fullRequest =</span><br><span class="line">          obtainRequest(</span><br><span class="line"><span class="built_in">              target,</span></span><br><span class="line"><span class="built_in">              targetListener,</span></span><br><span class="line"><span class="built_in">              requestOptions,</span></span><br><span class="line"><span class="built_in">              coordinator,</span></span><br><span class="line"><span class="built_in">              transitionOptions,</span></span><br><span class="line"><span class="built_in">              priority,</span></span><br><span class="line"><span class="built_in">              overrideWidth,</span></span><br><span class="line">              overrideHeight)<span class="comment">;</span></span><br><span class="line">      isThumbnailBuilt = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line">      // Recursively generate thumbnail requests.</span><br><span class="line">      Request thumbRequest =</span><br><span class="line">          thumbnailBuilder.buildRequestRecursive(</span><br><span class="line"><span class="built_in">              target,</span></span><br><span class="line"><span class="built_in">              targetListener,</span></span><br><span class="line"><span class="built_in">              coordinator,</span></span><br><span class="line"><span class="built_in">              thumbTransitionOptions,</span></span><br><span class="line"><span class="built_in">              thumbPriority,</span></span><br><span class="line"><span class="built_in">              thumbOverrideWidth,</span></span><br><span class="line"><span class="built_in">              thumbOverrideHeight,</span></span><br><span class="line">              thumbnailBuilder.requestOptions)<span class="comment">;</span></span><br><span class="line">      isThumbnailBuilt = <span class="literal">false</span><span class="comment">;</span></span><br><span class="line">      coordinator.setRequests(fullRequest, thumbRequest)<span class="comment">;</span></span><br><span class="line">      <span class="keyword">return</span> coordinator<span class="comment">;</span></span><br><span class="line">    &#125; else if (thumbSizeMultiplier != null) &#123;</span><br><span class="line"><span class="symbol">      // Base case:</span> thumbnail multiplier generates <span class="literal">a</span> thumbnail request, but cannot recurse.</span><br><span class="line">      ThumbnailRequestCoordinator coordinator = <span class="keyword">new</span> ThumbnailRequestCoordinator(parentCoordinator)<span class="comment">;</span></span><br><span class="line">      Request fullRequest =</span><br><span class="line">          obtainRequest(</span><br><span class="line"><span class="built_in">              target,</span></span><br><span class="line"><span class="built_in">              targetListener,</span></span><br><span class="line"><span class="built_in">              requestOptions,</span></span><br><span class="line"><span class="built_in">              coordinator,</span></span><br><span class="line"><span class="built_in">              transitionOptions,</span></span><br><span class="line"><span class="built_in">              priority,</span></span><br><span class="line"><span class="built_in">              overrideWidth,</span></span><br><span class="line">              overrideHeight)<span class="comment">;</span></span><br><span class="line">      RequestOptions thumbnailOptions = requestOptions.clone()</span><br><span class="line">          .sizeMultiplier(thumbSizeMultiplier)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">      Request thumbnailRequest =</span><br><span class="line">          obtainRequest(</span><br><span class="line"><span class="built_in">              target,</span></span><br><span class="line"><span class="built_in">              targetListener,</span></span><br><span class="line"><span class="built_in">              thumbnailOptions,</span></span><br><span class="line"><span class="built_in">              coordinator,</span></span><br><span class="line"><span class="built_in">              transitionOptions,</span></span><br><span class="line">              getThumbnailPriority(priority),</span><br><span class="line"><span class="built_in">              overrideWidth,</span></span><br><span class="line">              overrideHeight)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">      coordinator.setRequests(fullRequest, thumbnailRequest)<span class="comment">;</span></span><br><span class="line">      <span class="keyword">return</span> coordinator<span class="comment">;</span></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"><span class="symbol">      // Base case:</span> no thumbnail.</span><br><span class="line">      <span class="keyword">return</span> obtainRequest(</span><br><span class="line"><span class="built_in">          target,</span></span><br><span class="line"><span class="built_in">          targetListener,</span></span><br><span class="line"><span class="built_in">          requestOptions,</span></span><br><span class="line"><span class="built_in">          parentCoordinator,</span></span><br><span class="line"><span class="built_in">          transitionOptions,</span></span><br><span class="line"><span class="built_in">          priority,</span></span><br><span class="line"><span class="built_in">          overrideWidth,</span></span><br><span class="line">          overrideHeight)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private Request obtainRequest(</span><br><span class="line">      Target&lt;TranscodeType&gt; target,</span><br><span class="line">      RequestListener&lt;TranscodeType&gt; targetListener,</span><br><span class="line">      RequestOptions requestOptions,</span><br><span class="line">      RequestCoordinator requestCoordinator,</span><br><span class="line">      TransitionOptions&lt;?, ? super TranscodeType&gt; transitionOptions,</span><br><span class="line">      Priority priority,</span><br><span class="line">      int overrideWidth,</span><br><span class="line">      int overrideHeight) &#123;</span><br><span class="line">    <span class="keyword">return</span> SingleRequest.obtain(</span><br><span class="line"><span class="built_in">        context,</span></span><br><span class="line"><span class="built_in">        glideContext,</span></span><br><span class="line"><span class="built_in">        model,</span></span><br><span class="line"><span class="built_in">        transcodeClass,</span></span><br><span class="line"><span class="built_in">        requestOptions,</span></span><br><span class="line"><span class="built_in">        overrideWidth,</span></span><br><span class="line"><span class="built_in">        overrideHeight,</span></span><br><span class="line"><span class="built_in">        priority,</span></span><br><span class="line"><span class="built_in">        target,</span></span><br><span class="line"><span class="built_in">        targetListener,</span></span><br><span class="line"><span class="built_in">        requestListener,</span></span><br><span class="line"><span class="built_in">        requestCoordinator,</span></span><br><span class="line">        glideContext.getEngine(),</span><br><span class="line">        transitionOptions.getTransitionFactory())<span class="comment">;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>最新版本跟丢，还是回到郭霖老师的版本中继续</p>
<p>所以至此已经构建了一个Request对象，接下来我们看一下这个Request对象又是怎么执行的。回到刚才的into()方法，你会发现在第18行调用了requestTracker.runRequest()方法来去执行这个Request，那么我们跟进去瞧一瞧，如下所示：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts tracking the given request.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span>(<span class="params">Request request</span>) </span>&#123;</span><br><span class="line">    requests.<span class="keyword">add</span>(request);</span><br><span class="line">    <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">        request.begin();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pendingRequests.<span class="keyword">add</span>(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个简单的逻辑判断，就是先判断Glide当前是不是处理暂停状态，如果不是暂停状态就调用Request的begin()方法来执行Request</p>
<p>否则的话就先将Request添加到待执行队列里面，等暂停状态解除了之后再执行。</p>
<p>由于当前的Request对象是一个GenericRequest，因此这里就需要看GenericRequest中的begin()方法了，如下所示：</p>
<h3 id="begin"><a href="#begin" class="headerlink" title="begin"></a>begin</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    startTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">        onException(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    status = Status.WAITING_FOR_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">        onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">target</span>.getSize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isComplete() &amp;&amp; !isFailed() &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">        <span class="keyword">target</span>.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        logV(<span class="string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先如果model等于null，model也就是我们在第二步load()方法中传入的图片URL地址，这个时候会调用onException()方法。</p>
<p>如果你跟到onException()方法里面去看看，你会发现它最终会调用到一个setErrorPlaceholder()当中，如下所示：</p>
<h3 id="setErrorPlaceholder"><a href="#setErrorPlaceholder" class="headerlink" title="setErrorPlaceholder"></a>setErrorPlaceholder</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">setErrorPlaceholder</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!canNotifyStatusChanged()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Drawable <span class="keyword">error</span> = model == <span class="keyword">null</span> ? getFallbackDrawable() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">error</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">error</span> = getErrorDrawable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">error</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">error</span> = getPlaceholderDrawable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">target</span>.onLoadFailed(e, <span class="keyword">error</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法中会先去获取一个error的占位图，如果获取不到的话会再去获取一个loading占位图，然后调用target.onLoadFailed()方法并将占位图传入。</p>
<p>那么onLoadFailed()方法中做了什么呢？我们看一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTarget</span>&lt;<span class="title">Z</span>&gt; <span class="keyword">extends</span> <span class="title">ViewTarget</span>&lt;<span class="title">ImageView</span>, <span class="title">Z</span>&gt; <span class="keyword">implements</span> <span class="title">GlideAnimation</span>.<span class="title">ViewAdapter</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadStarted</span><span class="params">(Drawable placeholder)</span> </span>&#123;</span><br><span class="line">        view.setImageDrawable(placeholder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(Exception e, Drawable errorDrawable)</span> </span>&#123;</span><br><span class="line">        view.setImageDrawable(errorDrawable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是将这张error占位图显示到ImageView上而已，因为现在出现了异常，没办法展示正常的图片了。</p>
<p>而如果你仔细看下刚才begin()方法的第15行，你会发现它又调用了一个target.onLoadStarted()方法，并传入了一个loading占位图，也就说，在图片请求开始之前，会先使用这张占位图代替最终的图片显示。这就是placeholder()和error()这两个占位图API底层的实现原理。</p>
<p>我们继续回到begin()方法。</p>
<p>刚才讲了占位图的实现，那么具体的图片加载又是从哪里开始的呢？是在begin()方法的第10行和第12行。</p>
<p>这里要分两种情况，一种是你使用了override() API为图片指定了一个固定的宽高，一种是没有指定。</p>
<p>如果指定了的话，就会执行第10行代码，调用onSizeReady()方法。</p>
<p>如果没指定的话，就会执行第12行代码，调用target.getSize()方法。</p>
<p>这个target.getSize()方法的内部会根据ImageView的layout_width和layout_height值做一系列的计算，来算出图片应该的宽高。</p>
<p>具体的计算细节我就不带着大家分析了，总之在计算完之后，它也会调用onSizeReady()方法。也就是说，不管是哪种情况，最终都会调用到onSizeReady()方法，</p>
<h3 id="onSizeReady"><a href="#onSizeReady" class="headerlink" title="onSizeReady"></a>onSizeReady</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> onSizeReady(<span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        logV(<span class="string">"Got onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    status = Status.RUNNING;</span><br><span class="line">    <span class="built_in">width</span> = Math.<span class="built_in">round</span>(sizeMultiplier * <span class="built_in">width</span>);</span><br><span class="line">    <span class="built_in">height</span> = Math.<span class="built_in">round</span>(sizeMultiplier * <span class="built_in">height</span>);</span><br><span class="line">    ModelLoader&lt;A, T&gt; modelLoader = loadProvider.getModelLoader();</span><br><span class="line">    <span class="keyword">final</span> DataFetcher&lt;T&gt; dataFetcher = modelLoader.getResourceFetcher(model, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">    <span class="keyword">if</span> (dataFetcher == <span class="keyword">null</span>) &#123;</span><br><span class="line">        onException(<span class="keyword">new</span> Exception(<span class="string">"Failed to load model: \'"</span> + model + <span class="string">"\'"</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ResourceTranscoder&lt;Z, R&gt; transcoder = loadProvider.getTranscoder();</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        logV(<span class="string">"finished setup for calling load in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">    loadedFromMemoryCache = <span class="keyword">true</span>;</span><br><span class="line">    loadStatus = engine.load(signature, <span class="built_in">width</span>, <span class="built_in">height</span>, dataFetcher, loadProvider, transformation, transcoder,</span><br><span class="line">            priority, isMemoryCacheable, diskCacheStrategy, <span class="keyword">this</span>);</span><br><span class="line">    loadedFromMemoryCache = resource != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        logV(<span class="string">"finished onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先来看一下，在第12行调用了loadProvider.getModelLoader()方法，那么我们第一个要搞清楚的就是，这个loadProvider是什么？要搞清楚这点，需要先回到第二步的load()方法当中。</p>
<p>还记得load()方法是返回一个DrawableTypeRequest对象吗？刚才我们只是分析了DrawableTypeRequest当中的asBitmap()和asGif()方法，并没有仔细看它的构造函数，现在我们重新来看一下DrawableTypeRequest类的构造函数：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DrawableTypeRequest&lt;ModelType&gt;</span> <span class="keyword">extends</span> <span class="title">DrawableRequestBuilder&lt;ModelType&gt;</span> <span class="title">implements</span> <span class="title">DownloadOptions</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ModelLoader</span>&lt;<span class="type">ModelType</span>, <span class="type">InputStream</span>&gt; streamModelLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ModelLoader</span>&lt;<span class="type">ModelType</span>, <span class="type">ParcelFileDescriptor</span>&gt; fileDescriptorModelLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">RequestManager</span>.<span class="type">OptionsApplier</span> optionsApplier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static &lt;<span class="type">A</span>, <span class="type">Z</span>, <span class="type">R</span>&gt; <span class="type">FixedLoadProvider</span>&lt;<span class="type">A</span>, <span class="type">ImageVideoWrapper</span>, <span class="type">Z</span>, <span class="type">R</span>&gt; buildProvider(<span class="type">Glide</span> glide,</span><br><span class="line">            <span class="type">ModelLoader</span>&lt;<span class="type">A</span>, <span class="type">InputStream</span>&gt; streamModelLoader,</span><br><span class="line">            <span class="type">ModelLoader</span>&lt;<span class="type">A</span>, <span class="type">ParcelFileDescriptor</span>&gt; fileDescriptorModelLoader, <span class="type">Class</span>&lt;<span class="type">Z</span>&gt; resourceClass,</span><br><span class="line">            <span class="type">Class</span>&lt;<span class="type">R</span>&gt; transcodedClass,</span><br><span class="line">            <span class="type">ResourceTranscoder</span>&lt;<span class="type">Z</span>, <span class="type">R</span>&gt; transcoder) &#123;</span><br><span class="line">        <span class="keyword">if</span> (streamModelLoader == <span class="literal">null</span> &amp;&amp; fileDescriptorModelLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (transcoder == <span class="literal">null</span>) &#123;</span><br><span class="line">            transcoder = glide.buildTranscoder(resourceClass, transcodedClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DataLoadProvider</span>&lt;<span class="type">ImageVideoWrapper</span>, <span class="type">Z</span>&gt; dataLoadProvider = glide.buildDataProvider(<span class="type">ImageVideoWrapper</span>.<span class="keyword">class</span>,</span><br><span class="line">                resourceClass);</span><br><span class="line">        <span class="type">ImageVideoModelLoader</span>&lt;<span class="type">A</span>&gt; modelLoader = <span class="keyword">new</span> <span class="type">ImageVideoModelLoader</span>&lt;<span class="type">A</span>&gt;(streamModelLoader,</span><br><span class="line">                fileDescriptorModelLoader);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">FixedLoadProvider</span>&lt;<span class="type">A</span>, <span class="type">ImageVideoWrapper</span>, <span class="type">Z</span>, <span class="type">R</span>&gt;(modelLoader, transcoder, dataLoadProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">DrawableTypeRequest</span>(<span class="type">Class</span>&lt;<span class="type">ModelType</span>&gt; modelClass, <span class="type">ModelLoader</span>&lt;<span class="type">ModelType</span>, <span class="type">InputStream</span>&gt; streamModelLoader,</span><br><span class="line">            <span class="type">ModelLoader</span>&lt;<span class="type">ModelType</span>, <span class="type">ParcelFileDescriptor</span>&gt; fileDescriptorModelLoader, <span class="type">Context</span> context, <span class="type">Glide</span> glide,</span><br><span class="line">            <span class="type">RequestTracker</span> requestTracker, <span class="type">Lifecycle</span> lifecycle, <span class="type">RequestManager</span>.<span class="type">OptionsApplier</span> optionsApplier) &#123;</span><br><span class="line">        <span class="keyword">super</span>(context, modelClass,</span><br><span class="line">                buildProvider(glide, streamModelLoader, fileDescriptorModelLoader, <span class="type">GifBitmapWrapper</span>.<span class="keyword">class</span>,</span><br><span class="line">                        <span class="type">GlideDrawable</span>.<span class="keyword">class</span>, <span class="literal">null</span>),</span><br><span class="line">                glide, requestTracker, lifecycle);</span><br><span class="line">        <span class="keyword">this</span>.streamModelLoader = streamModelLoader;</span><br><span class="line">        <span class="keyword">this</span>.fileDescriptorModelLoader = fileDescriptorModelLoader;</span><br><span class="line">        <span class="keyword">this</span>.optionsApplier = optionsApplier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第29行，也就是构造函数中，调用了一个buildProvider()方法，并把streamModelLoader和fileDescriptorModelLoader等参数传入到这个方法中，这两个ModelLoader就是之前在loadGeneric()方法中构建出来的。</p>
<p>再来看一下buildProvider()方法里面做了什么，在第16行调用了glide.buildTranscoder()方法来构建一个ResourceTranscoder，它是用于对图片进行转码的，由于ResourceTranscoder是一个接口，这里实际会构建出一个GifBitmapWrapperDrawableTranscoder对象。</p>
<p>在第18行调用了glide.buildDataProvider()方法来构建一个DataLoadProvider，它是用于对图片进行编解码的，由于DataLoadProvider是一个接口，这里实际会构建出一个ImageVideoGifDrawableLoadProvider对象。</p>
<p>在第20行，new了一个ImageVideoModelLoader的实例，并把之前loadGeneric()方法中构建的两个ModelLoader封装到了ImageVideoModelLoader当中。</p>
<p>在第22行，new出一个FixedLoadProvider，并把刚才构建的出来的GifBitmapWrapperDrawableTranscoder、ImageVideoModelLoader、ImageVideoGifDrawableLoadProvider都封装进去，这个也就是onSizeReady()方法中的loadProvider了。</p>
<p>我们回到onSizeReady()方法中，在onSizeReady()方法的第12行和第18行，分别调用了loadProvider的getModelLoader()方法和getTranscoder()方法，那么得到的对象也就是刚才我们分析的ImageVideoModelLoader和GifBitmapWrapperDrawableTranscoder了。而在第13行，又调用了ImageVideoModelLoader的getResourceFetcher()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageVideoModelLoader</span>&lt;<span class="title">A</span>&gt; <span class="keyword">implements</span> <span class="title">ModelLoader</span>&lt;<span class="title">A</span>, <span class="title">ImageVideoWrapper</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"IVML"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModelLoader&lt;A, InputStream&gt; streamLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorLoader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageVideoModelLoader</span><span class="params">(ModelLoader&lt;A, InputStream&gt; streamLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">            ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (streamLoader == <span class="keyword">null</span> &amp;&amp; fileDescriptorLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"At least one of streamLoader and fileDescriptorLoader must be non null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.streamLoader = streamLoader;</span><br><span class="line">        <span class="keyword">this</span>.fileDescriptorLoader = fileDescriptorLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataFetcher&lt;ImageVideoWrapper&gt; <span class="title">getResourceFetcher</span><span class="params">(A model, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        DataFetcher&lt;InputStream&gt; streamFetcher = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (streamLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            streamFetcher = streamLoader.getResourceFetcher(model, width, height);</span><br><span class="line">        &#125;</span><br><span class="line">        DataFetcher&lt;ParcelFileDescriptor&gt; fileDescriptorFetcher = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (fileDescriptorLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fileDescriptorFetcher = fileDescriptorLoader.getResourceFetcher(model, width, height);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (streamFetcher != <span class="keyword">null</span> || fileDescriptorFetcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ImageVideoFetcher(streamFetcher, fileDescriptorFetcher);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageVideoFetcher</span> <span class="keyword">implements</span> <span class="title">DataFetcher</span>&lt;<span class="title">ImageVideoWrapper</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DataFetcher&lt;InputStream&gt; streamFetcher;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DataFetcher&lt;ParcelFileDescriptor&gt; fileDescriptorFetcher;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ImageVideoFetcher</span><span class="params">(DataFetcher&lt;InputStream&gt; streamFetcher,</span></span></span><br><span class="line"><span class="function"><span class="params">                DataFetcher&lt;ParcelFileDescriptor&gt; fileDescriptorFetcher)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.streamFetcher = streamFetcher;</span><br><span class="line">            <span class="keyword">this</span>.fileDescriptorFetcher = fileDescriptorFetcher;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第20行会先调用streamLoader.getResourceFetcher()方法获取一个DataFetcher，而这个streamLoader其实就是我们在loadGeneric()方法中构建出的StreamStringLoader，调用它的getResourceFetcher()方法会得到一个HttpUrlFetcher对象。</p>
<p>然后在第28行new出了一个ImageVideoFetcher对象，并把获得的HttpUrlFetcher对象传进去。也就是说，ImageVideoModelLoader的getResourceFetcher()方法得到的是一个ImageVideoFetcher。</p>
<p>我们再次回到onSizeReady()方法，在onSizeReady()方法的第23行，这里将刚才获得的ImageVideoFetcher、GifBitmapWrapperDrawableTranscoder等等一系列的值一起传入到了Engine的load()方法当中。接下来我们就要看一看，这个Engine的load()方法</p>
<h3 id="load-1"><a href="#load-1" class="headerlink" title="load()"></a>load()</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Engine implements EngineJobListener,</span><br><span class="line">        MemoryCache.ResourceRemovedListener,</span><br><span class="line">        EngineResource.ResourceListener &#123;</span><br><span class="line"></span><br><span class="line">    ...    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T, Z, R&gt; LoadStatus load(Key signature, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>, DataFetcher&lt;T&gt; fetcher,</span><br><span class="line">            DataLoadProvider&lt;T, Z&gt; loadProvider, Transformation&lt;Z&gt; transformation, ResourceTranscoder&lt;Z, R&gt; transcoder,</span><br><span class="line">            Priority priority, <span class="built_in">boolean</span> isMemoryCacheable, DiskCacheStrategy diskCacheStrategy, ResourceCallback cb) &#123;</span><br><span class="line">        Util.assertMainThread();</span><br><span class="line">        <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">String</span> id = fetcher.getId();</span><br><span class="line">        EngineKey <span class="built_in">key</span> = keyFactory.buildKey(id, signature, <span class="built_in">width</span>, <span class="built_in">height</span>, loadProvider.getCacheDecoder(),</span><br><span class="line">                loadProvider.getSourceDecoder(), transformation, loadProvider.getEncoder(),</span><br><span class="line">                transcoder, loadProvider.getSourceEncoder());</span><br><span class="line"></span><br><span class="line">        EngineResource&lt;?&gt; cached = loadFromCache(<span class="built_in">key</span>, isMemoryCacheable);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cb.onResourceReady(cached);</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Loaded resource from cache"</span>, startTime, <span class="built_in">key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EngineResource&lt;?&gt; active = loadFromActiveResources(<span class="built_in">key</span>, isMemoryCacheable);</span><br><span class="line">        <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cb.onResourceReady(active);</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Loaded resource from active resources"</span>, startTime, <span class="built_in">key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EngineJob current = jobs.<span class="built_in">get</span>(<span class="built_in">key</span>);</span><br><span class="line">        <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">            current.addCallback(cb);</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Added to existing load"</span>, startTime, <span class="built_in">key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EngineJob engineJob = engineJobFactory.build(<span class="built_in">key</span>, isMemoryCacheable);</span><br><span class="line">        DecodeJob&lt;T, Z, R&gt; decodeJob = <span class="keyword">new</span> DecodeJob&lt;T, Z, R&gt;(<span class="built_in">key</span>, <span class="built_in">width</span>, <span class="built_in">height</span>, fetcher, loadProvider, transformation,</span><br><span class="line">                transcoder, diskCacheProvider, diskCacheStrategy, priority);</span><br><span class="line">        EngineRunnable runnable = <span class="keyword">new</span> EngineRunnable(engineJob, decodeJob, priority);</span><br><span class="line">        jobs.put(<span class="built_in">key</span>, engineJob);</span><br><span class="line">        engineJob.addCallback(cb);</span><br><span class="line">        engineJob.start(runnable);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logWithTimeAndKey(<span class="string">"Started new load"</span>, startTime, <span class="built_in">key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要从第45行看起就行。这里构建了一个EngineJob，它的主要作用就是用来开启线程的，为后面的异步加载图片做准备。</p>
<p>接下来第46行创建了一个DecodeJob对象，从名字上来看，它好像是用来对图片进行解码的，但实际上它的任务十分繁重，待会我们就知道了。</p>
<p>继续往下看，第48行创建了一个EngineRunnable对象，并且在51行调用了EngineJob的start()方法来运行EngineRunnable对象，这实际上就是让EngineRunnable的run()方法在子线程当中执行了。</p>
<p>那么我们现在就可以去看看EngineRunnable的run()方法，如下所示：</p>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> void run() &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Exception</span> <span class="keyword">exception</span> = <span class="keyword">null</span>;</span><br><span class="line">    Resource<span class="meta">&lt;?</span>&gt; resource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        resource = decode();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Exception decoding"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exception</span> = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resource.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resource == <span class="keyword">null</span>) &#123;</span><br><span class="line">        onLoadFailed(<span class="keyword">exception</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onLoadComplete(resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第9行，这里调用了一个decode()方法，并且这个方法返回了一个Resource对象。看上去所有的逻辑应该都在这个decode()方法执行的了，那我们跟进去瞧一瞧：</p>
<h3 id="decode"><a href="#decode" class="headerlink" title="decode"></a>decode</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Resource&lt;?&gt; decode() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDecodingFromCache()) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="title">decodeFromCache</span><span class="params">()</span></span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="title">decodeFromSource</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>decode()方法中又分了两种情况，从缓存当中去decode图片的话就会执行decodeFromCache()，否则的话就执行decodeFromSource()。本篇文章中我们不讨论缓存的情况，那么就直接来看decodeFromSource()方法的代码，如下所示</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Resource&lt;?&gt; decodeFromSource() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> decodeJob.<span class="title">decodeFromSource</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又调用了DecodeJob的decodeFromSource()方法</p>
<h3 id="decodeFromSource"><a href="#decodeFromSource" class="headerlink" title="decodeFromSource"></a>decodeFromSource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">A</span>, <span class="title">T</span>, <span class="title">Z</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;Z&gt; <span class="title">decodeFromSource</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Resource&lt;T&gt; decoded = decodeSource();</span><br><span class="line">        <span class="keyword">return</span> transformEncodeAndTranscode(decoded);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Resource&lt;T&gt; <span class="title">decodeSource</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Resource&lt;T&gt; decoded = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">            <span class="keyword">final</span> A data = fetcher.loadData(priority);</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Fetched data"</span>, startTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            decoded = decodeFromSourceData(data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            fetcher.cleanup();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decoded;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先来看一下decodeFromSource()方法，其实它的工作分为两部，第一步是调用decodeSource()方法来获得一个Resource对象，第二步是调用transformEncodeAndTranscode()方法来处理这个Resource对象。</p>
<p>我们先来看第一步，decodeSource()方法中的逻辑也并不复杂，首先在第14行调用了fetcher.loadData()方法。其实就是刚才在onSizeReady()方法中得到的ImageVideoFetcher对象，这里调用它的loadData()方法，代码如下所示：</p>
<p>$</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> ImageVideoWrapper loadData(Priority priority) throws Exception &#123;</span><br><span class="line">    InputStream is = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (streamFetcher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = streamFetcher.loadData(priority);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">Log</span>.isLoggable(TAG, <span class="built_in">Log</span>.VERBOSE)) &#123;</span><br><span class="line">                <span class="built_in">Log</span>.v(TAG, <span class="string">"Exception fetching input stream, trying ParcelFileDescriptor"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fileDescriptorFetcher == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ParcelFileDescriptor fileDescriptor = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (fileDescriptorFetcher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileDescriptor = fileDescriptorFetcher.loadData(priority);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">Log</span>.isLoggable(TAG, <span class="built_in">Log</span>.VERBOSE)) &#123;</span><br><span class="line">                <span class="built_in">Log</span>.v(TAG, <span class="string">"Exception fetching ParcelFileDescriptor"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ImageVideoWrapper(is, fileDescriptor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在ImageVideoFetcher的loadData()方法的第6行，这里又去调用了streamFetcher.loadData()方法，然就是刚才在组装ImageVideoFetcher对象时传进来的HttpUrlFetcher了。</p>
<p>因此这里又会去调用HttpUrlFetcher的loadData()方法，那么我们继续跟进去瞧一瞧：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUrlFetcher</span> <span class="keyword">implements</span> <span class="title">DataFetcher</span>&lt;<span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">InputStream <span class="title">loadData</span><span class="params">(Priority priority)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loadDataWithRedirects(glideUrl.toURL(), <span class="number">0</span> <span class="comment">/*redirects*/</span>, <span class="keyword">null</span> <span class="comment">/*lastUrl*/</span>, glideUrl.getHeaders());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InputStream loadDataWithRedirects(URL url, <span class="keyword">int</span> redirects, URL lastUrl, Map&lt;String, String&gt; headers)</span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (redirects &gt;= MAXIMUM_REDIRECTS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Too many (&gt; "</span> + MAXIMUM_REDIRECTS + <span class="string">") redirects!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Comparing the URLs using .equals performs additional network I/O and is generally broken.</span></span><br><span class="line">            <span class="comment">// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lastUrl != <span class="keyword">null</span> &amp;&amp; url.toURI().equals(lastUrl.toURI())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"In re-direct loop"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                <span class="comment">// Do nothing, this is best effort.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        urlConnection = connectionFactory.build(url);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; headerEntry : headers.entrySet()) &#123;</span><br><span class="line">          urlConnection.addRequestProperty(headerEntry.getKey(), headerEntry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        urlConnection.setConnectTimeout(<span class="number">2500</span>);</span><br><span class="line">        urlConnection.setReadTimeout(<span class="number">2500</span>);</span><br><span class="line">        urlConnection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">        urlConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Connect explicitly to avoid errors in decoders if connection fails.</span></span><br><span class="line">        urlConnection.connect();</span><br><span class="line">        <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> statusCode = urlConnection.getResponseCode();</span><br><span class="line">        <span class="keyword">if</span> (statusCode / <span class="number">100</span> == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> <span class="title">getStreamForSuccessfulRequest</span><span class="params">(urlConnection)</span></span>;</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(statusCode / <span class="number">100</span> == <span class="number">3</span>)</span> </span>&#123;</span><br><span class="line">            String redirectUrlString = urlConnection.getHeaderField(<span class="string">"Location"</span>);</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(redirectUrlString)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Received empty or null redirect url"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            URL redirectUrl = <span class="keyword">new</span> URL(url, redirectUrlString);</span><br><span class="line">            <span class="function"><span class="keyword">return</span> <span class="title">loadDataWithRedirects</span><span class="params">(redirectUrl, redirects + <span class="number">1</span>, url, headers)</span></span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unable to retrieve response code from HttpUrlConnection."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Request failed "</span> + statusCode + <span class="string">": "</span> + urlConnection.getResponseMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InputStream getStreamForSuccessfulRequest(HttpURLConnection urlConnection)</span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(urlConnection.getContentEncoding())) &#123;</span><br><span class="line">            <span class="keyword">int</span> contentLength = urlConnection.getContentLength();</span><br><span class="line">            stream = ContentLengthInputStream.obtain(urlConnection.getInputStream(), contentLength);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Got non empty content encoding: "</span> + urlConnection.getContentEncoding());</span><br><span class="line">            &#125;</span><br><span class="line">            stream = urlConnection.getInputStream();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadData()方法只是返回了一个InputStream,回到刚才ImageVideoFetcher的loadData()方法中，在这个方法的最后一行，创建了一个ImageVideoWrapper对象，并把刚才得到的InputStream作为参数传了进去。</p>
<p>我们回到再上一层，也就是DecodeJob的decodeSource()方法当中，在得到了这个ImageVideoWrapper对象之后，紧接着又将这个对象传入到了decodeFromSourceData()当中，来去解码这个对象。decodeFromSourceData()方法的代码如下所示</p>
<h3 id="decodeFromSourceData"><a href="#decodeFromSourceData" class="headerlink" title="decodeFromSourceData"></a>decodeFromSourceData</h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">private</span> <span class="type">Resource</span>&lt;<span class="type">T</span>&gt; decodeFromSourceData(<span class="type">A</span> <span class="class"><span class="keyword">data</span>) throws <span class="type">IOException</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">final</span> <span class="type">Resource</span>&lt;<span class="type">T</span>&gt; <span class="title">decoded</span>;</span></span><br><span class="line"><span class="class">    <span class="title">if</span> (<span class="title">diskCacheStrategy</span>.<span class="title">cacheSource</span>()) &#123;</span></span><br><span class="line"><span class="class">        <span class="title">decoded</span> = <span class="title">cacheAndDecodeSourceData</span>(<span class="title">data</span>);</span></span><br><span class="line"><span class="class">    &#125; else &#123;</span></span><br><span class="line"><span class="class">        <span class="title">long</span> <span class="title">startTime</span> = <span class="type">LogTime</span>.<span class="title">getLogTime</span>();</span></span><br><span class="line"><span class="class">        <span class="title">decoded</span> = <span class="title">loadProvider</span>.<span class="title">getSourceDecoder</span>().<span class="title">decode</span>(<span class="title">data</span>, <span class="title">width</span>, <span class="title">height</span>);</span></span><br><span class="line"><span class="class">        <span class="title">if</span> (<span class="type">Log</span>.<span class="title">isLoggable</span>(<span class="type">TAG</span>, <span class="type">Log</span>.<span class="type">VERBOSE</span>)) &#123;</span></span><br><span class="line"><span class="class">            <span class="title">logWithTimeAndKey</span>("<span class="type">Decoded</span> <span class="title">from</span> <span class="title">source</span>", <span class="title">startTime</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">    return decoded;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第7行调用了loadProvider.getSourceDecoder().decode()方法来进行解码。</p>
<p>loadProvider就是刚才在onSizeReady()方法中得到的FixedLoadProvider，而getSourceDecoder()得到的则是一个GifBitmapWrapperResourceDecoder对象，也就是要调用这个对象的decode()方法来对图片进行解码。</p>
<p>来看下GifBitmapWrapperResourceDecoder的代码：</p>
<h3 id="GifBitmapWrapperResourceDecoder"><a href="#GifBitmapWrapperResourceDecoder" class="headerlink" title="GifBitmapWrapperResourceDecoder"></a>GifBitmapWrapperResourceDecoder</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class GifBitmapWrapperResourceDecoder implements ResourceDecoder&lt;ImageVideoWrapper, GifBitmapWrapper&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(<span class="string">"resource"</span>)</span><br><span class="line">    <span class="comment">// @see ResourceDecoder.decode</span></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Resource&lt;GifBitmapWrapper&gt; decode(ImageVideoWrapper source, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayPool pool = ByteArrayPool.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">byte</span>[] tempBytes = pool.getBytes();</span><br><span class="line">        GifBitmapWrapper wrapper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wrapper = decode(source, <span class="built_in">width</span>, <span class="built_in">height</span>, tempBytes);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            pool.releaseBytes(tempBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wrapper != <span class="keyword">null</span> ? <span class="keyword">new</span> GifBitmapWrapperResource(wrapper) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GifBitmapWrapper decode(ImageVideoWrapper source, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>, <span class="built_in">byte</span>[] bytes) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> GifBitmapWrapper result;</span><br><span class="line">        <span class="keyword">if</span> (source.getStream() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = decodeStream(source, <span class="built_in">width</span>, <span class="built_in">height</span>, bytes);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = decodeBitmapWrapper(source, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GifBitmapWrapper decodeStream(ImageVideoWrapper source, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>, <span class="built_in">byte</span>[] bytes)</span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        InputStream bis = streamFactory.build(source.getStream(), bytes);</span><br><span class="line">        bis.mark(MARK_LIMIT_BYTES);</span><br><span class="line">        ImageHeaderParser.ImageType type = parser.parse(bis);</span><br><span class="line">        bis.reset();</span><br><span class="line">        GifBitmapWrapper result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == ImageHeaderParser.ImageType.GIF) &#123;</span><br><span class="line">            result = decodeGifWrapper(bis, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Decoding the gif may fail even if the type matches.</span></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We can only reset the buffered InputStream, so to start from the beginning of the stream, we need to</span></span><br><span class="line">            <span class="comment">// pass in a new source containing the buffered stream rather than the original stream.</span></span><br><span class="line">            ImageVideoWrapper forBitmapDecoder = <span class="keyword">new</span> ImageVideoWrapper(bis, source.getFileDescriptor());</span><br><span class="line">            result = decodeBitmapWrapper(forBitmapDecoder, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GifBitmapWrapper decodeBitmapWrapper(ImageVideoWrapper toDecode, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        GifBitmapWrapper result = <span class="keyword">null</span>;</span><br><span class="line">        Resource&lt;Bitmap&gt; bitmapResource = bitmapDecoder.decode(toDecode, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">        <span class="keyword">if</span> (bitmapResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = <span class="keyword">new</span> GifBitmapWrapper(bitmapResource, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，在decode()方法中，又去调用了另外一个decode()方法的重载。</p>
<p>然后在第23行调用了decodeStream()方法，准备从服务器返回的流当中读取数据。</p>
<p>decodeStream()方法中会先从流中读取2个字节的数据，来判断这张图是GIF图还是普通的静图，如果是GIF图就调用decodeGifWrapper()方法来进行解码，如果是普通的静图就用调用decodeBitmapWrapper()方法来进行解码。</p>
<p>这里我们只分析普通静图的实现流程.</p>
<p>来看一下decodeBitmapWrapper()方法，这里在第52行调用了bitmapDecoder.decode()方法。这个bitmapDecoder是一个ImageVideoBitmapDecoder对象，那么我们来看一下它的代码，如下所示：</p>
<h3 id="ImageVideoBitmapDecoder"><a href="#ImageVideoBitmapDecoder" class="headerlink" title="ImageVideoBitmapDecoder"></a>ImageVideoBitmapDecoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageVideoBitmapDecoder</span> <span class="keyword">implements</span> <span class="title">ResourceDecoder</span>&lt;<span class="title">ImageVideoWrapper</span>, <span class="title">Bitmap</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceDecoder&lt;InputStream, Bitmap&gt; streamDecoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceDecoder&lt;ParcelFileDescriptor, Bitmap&gt; fileDescriptorDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageVideoBitmapDecoder</span><span class="params">(ResourceDecoder&lt;InputStream, Bitmap&gt; streamDecoder,</span></span></span><br><span class="line"><span class="function"><span class="params">            ResourceDecoder&lt;ParcelFileDescriptor, Bitmap&gt; fileDescriptorDecoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.streamDecoder = streamDecoder;</span><br><span class="line">        <span class="keyword">this</span>.fileDescriptorDecoder = fileDescriptorDecoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;Bitmap&gt; <span class="title">decode</span><span class="params">(ImageVideoWrapper source, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Resource&lt;Bitmap&gt; result = <span class="keyword">null</span>;</span><br><span class="line">        InputStream is = source.getStream();</span><br><span class="line">        <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = streamDecoder.decode(is, width, height);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                    Log.v(TAG, <span class="string">"Failed to load image from stream, trying FileDescriptor"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ParcelFileDescriptor fileDescriptor = source.getFileDescriptor();</span><br><span class="line">            <span class="keyword">if</span> (fileDescriptor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result = fileDescriptorDecoder.decode(fileDescriptor, width, height);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第14行先调用了source.getStream()来获取到服务器返回的InputStream，然后在第17行调用streamDecoder.decode()方法进行解码。streamDecode是一个StreamBitmapDecoder对象，那么我们再来看这个类的源码，如下所示：</p>
<h3 id="StreamBitmapDecoder"><a href="#StreamBitmapDecoder" class="headerlink" title="StreamBitmapDecoder"></a>StreamBitmapDecoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamBitmapDecoder</span> <span class="keyword">implements</span> <span class="title">ResourceDecoder</span>&lt;<span class="title">InputStream</span>, <span class="title">Bitmap</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Downsampler downsampler;</span><br><span class="line">    <span class="keyword">private</span> BitmapPool bitmapPool;</span><br><span class="line">    <span class="keyword">private</span> DecodeFormat decodeFormat;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StreamBitmapDecoder</span><span class="params">(Downsampler downsampler, BitmapPool bitmapPool, DecodeFormat decodeFormat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.downsampler = downsampler;</span><br><span class="line">        <span class="keyword">this</span>.bitmapPool = bitmapPool;</span><br><span class="line">        <span class="keyword">this</span>.decodeFormat = decodeFormat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;Bitmap&gt; <span class="title">decode</span><span class="params">(InputStream source, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        Bitmap bitmap = downsampler.decode(source, bitmapPool, width, height, decodeFormat);</span><br><span class="line">        <span class="keyword">return</span> BitmapResource.obtain(bitmap, bitmapPool);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的decode()方法又去调用了Downsampler的decode()方法。接下来又到了激动人心的时刻了，Downsampler的代码如下所示</p>
<h3 id="Downsampler"><a href="#Downsampler" class="headerlink" title="Downsampler"></a>Downsampler</h3><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> Downsampler implements BitmapDecoder&lt;InputStream&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Bitmap decode(InputStream <span class="keyword">is</span>, BitmapPool pool, <span class="keyword">int</span> outWidth, <span class="keyword">int</span> outHeight, DecodeFormat decodeFormat) &#123;</span><br><span class="line">        <span class="keyword">final</span> ByteArrayPool byteArrayPool = ByteArrayPool.get();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] bytesForOptions = byteArrayPool.getBytes();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] bytesForStream = byteArrayPool.getBytes();</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = getDefaultOptions();</span><br><span class="line">        <span class="comment">// Use to fix the mark limit to avoid allocating buffers that fit entire images.</span></span><br><span class="line">        RecyclableBufferedInputStream bufferedStream = <span class="keyword">new</span> RecyclableBufferedInputStream(</span><br><span class="line">                <span class="keyword">is</span>, bytesForStream);</span><br><span class="line">        <span class="comment">// Use to retrieve exceptions thrown while reading.</span></span><br><span class="line">        <span class="comment">// TODO(#126): when the framework no longer returns partially decoded Bitmaps or provides a way to determine</span></span><br><span class="line">        <span class="comment">// if a Bitmap is partially decoded, consider removing.</span></span><br><span class="line">        ExceptionCatchingInputStream exceptionStream =</span><br><span class="line">                ExceptionCatchingInputStream.obtain(bufferedStream);</span><br><span class="line">        <span class="comment">// Use to read data.</span></span><br><span class="line">        <span class="comment">// Ensures that we can always reset after reading an image header so that we can still attempt to decode the</span></span><br><span class="line">        <span class="comment">// full image even when the header decode fails and/or overflows our read buffer. See #283.</span></span><br><span class="line">        MarkEnforcingInputStream invalidatingStream = <span class="keyword">new</span> MarkEnforcingInputStream(exceptionStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exceptionStream.mark(MARK_POSITION);</span><br><span class="line">            <span class="keyword">int</span> orientation = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                orientation = <span class="keyword">new</span> ImageHeaderParser(exceptionStream).getOrientation();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Log.isLoggable(TAG, Log.WARN)) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Cannot determine the image orientation from header"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    exceptionStream.reset();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.WARN)) &#123;</span><br><span class="line">                        Log.w(TAG, <span class="string">"Cannot reset the input stream"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            options.inTempStorage = bytesForOptions;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] inDimens = getDimensions(invalidatingStream, bufferedStream, options);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> inWidth = inDimens[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> inHeight = inDimens[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> degreesToRotate = TransformationUtils.getExifOrientationDegrees(orientation);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> sampleSize = getRoundedSampleSize(degreesToRotate, inWidth, inHeight, outWidth, outHeight);</span><br><span class="line">            <span class="keyword">final</span> Bitmap downsampled =</span><br><span class="line">                    downsampleWithSize(invalidatingStream, bufferedStream, options, pool, inWidth, inHeight, sampleSize,</span><br><span class="line">                            decodeFormat);</span><br><span class="line">            <span class="comment">// BitmapFactory swallows exceptions during decodes and in some cases when inBitmap is non null, may catch</span></span><br><span class="line">            <span class="comment">// and log a stack trace but still return a non null bitmap. To avoid displaying partially decoded bitmaps,</span></span><br><span class="line">            <span class="comment">// we catch exceptions reading from the stream in our ExceptionCatchingInputStream and throw them here.</span></span><br><span class="line">            <span class="keyword">final</span> Exception streamException = exceptionStream.getException();</span><br><span class="line">            <span class="keyword">if</span> (streamException != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(streamException);</span><br><span class="line">            &#125;</span><br><span class="line">            Bitmap rotated = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (downsampled != <span class="literal">null</span>) &#123;</span><br><span class="line">                rotated = TransformationUtils.rotateImageExif(downsampled, pool, orientation);</span><br><span class="line">                <span class="keyword">if</span> (!downsampled.equals(rotated) &amp;&amp; !pool.put(downsampled)) &#123;</span><br><span class="line">                    downsampled.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> rotated;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            byteArrayPool.releaseBytes(bytesForOptions);</span><br><span class="line">            byteArrayPool.releaseBytes(bytesForStream);</span><br><span class="line">            exceptionStream.release();</span><br><span class="line">            releaseOptions(options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Bitmap downsampleWithSize(MarkEnforcingInputStream <span class="keyword">is</span>, RecyclableBufferedInputStream  bufferedStream,</span><br><span class="line">            BitmapFactory.Options options, BitmapPool pool, <span class="keyword">int</span> inWidth, <span class="keyword">int</span> inHeight, <span class="keyword">int</span> sampleSize,</span><br><span class="line">            DecodeFormat decodeFormat) &#123;</span><br><span class="line">        <span class="comment">// Prior to KitKat, the inBitmap size must exactly match the size of the bitmap we're decoding.</span></span><br><span class="line">        Bitmap.Config config = getConfig(<span class="keyword">is</span>, decodeFormat);</span><br><span class="line">        options.inSampleSize = sampleSize;</span><br><span class="line">        options.inPreferredConfig = config;</span><br><span class="line">        <span class="keyword">if</span> ((options.inSampleSize == <span class="number">1</span> || Build.VERSION_CODES.KITKAT &lt;= Build.VERSION.SDK_INT) &amp;&amp; shouldUsePool(<span class="keyword">is</span>)) &#123;</span><br><span class="line">            <span class="keyword">int</span> targetWidth = (<span class="keyword">int</span>) Math.ceil(inWidth / (<span class="built_in">double</span>) sampleSize);</span><br><span class="line">            <span class="keyword">int</span> targetHeight = (<span class="keyword">int</span>) Math.ceil(inHeight / (<span class="built_in">double</span>) sampleSize);</span><br><span class="line">            <span class="comment">// BitmapFactory will clear out the Bitmap before writing to it, so getDirty is safe.</span></span><br><span class="line">            setInBitmap(options, pool.getDirty(targetWidth, targetHeight, config));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decodeStream(<span class="keyword">is</span>, bufferedStream, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A method for getting the dimensions of an image from the given InputStream.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param is The InputStream representing the image.</span></span><br><span class="line"><span class="comment">     * @param options The options to pass to</span></span><br><span class="line"><span class="comment">     *          &#123;@link BitmapFactory#decodeStream(InputStream, android.graphics.Rect,</span></span><br><span class="line"><span class="comment">     *              BitmapFactory.Options)&#125;.</span></span><br><span class="line"><span class="comment">     * @return an array containing the dimensions of the image in the form &#123;width, height&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] getDimensions(MarkEnforcingInputStream <span class="keyword">is</span>, RecyclableBufferedInputStream bufferedStream,</span><br><span class="line">            BitmapFactory.Options options) &#123;</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">true</span>;</span><br><span class="line">        decodeStream(<span class="keyword">is</span>, bufferedStream, options);</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[] &#123; options.outWidth, options.outHeight &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Bitmap decodeStream(MarkEnforcingInputStream <span class="keyword">is</span>, RecyclableBufferedInputStream bufferedStream,</span><br><span class="line">            BitmapFactory.Options options) &#123;</span><br><span class="line">         <span class="keyword">if</span> (options.inJustDecodeBounds) &#123;</span><br><span class="line">             <span class="comment">// This is large, but jpeg headers are not size bounded so we need something large enough to minimize</span></span><br><span class="line">             <span class="comment">// the possibility of not being able to fit enough of the header in the buffer to get the image size so</span></span><br><span class="line">             <span class="comment">// that we don't fail to load images. The BufferedInputStream will create a new buffer of 2x the</span></span><br><span class="line">             <span class="comment">// original size each time we use up the buffer space without passing the mark so this is a maximum</span></span><br><span class="line">             <span class="comment">// bound on the buffer size, not a default. Most of the time we won't go past our pre-allocated 16kb.</span></span><br><span class="line">             <span class="keyword">is</span>.mark(MARK_POSITION);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// Once we've read the image header, we no longer need to allow the buffer to expand in size. To avoid</span></span><br><span class="line">             <span class="comment">// unnecessary allocations reading image data, we fix the mark limit so that it is no larger than our</span></span><br><span class="line">             <span class="comment">// current buffer size here. See issue #225.</span></span><br><span class="line">             bufferedStream.fixMarkLimit();</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">final</span> Bitmap result = BitmapFactory.decodeStream(<span class="keyword">is</span>, <span class="literal">null</span>, options);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (options.inJustDecodeBounds) &#123;</span><br><span class="line">                <span class="keyword">is</span>.reset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.ERROR)) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"Exception loading inDecodeBounds="</span> + options.inJustDecodeBounds</span><br><span class="line">                        + <span class="string">" sample="</span> + options.inSampleSize, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对服务器返回的InputStream的读取，以及对图片的加载全都在这里了。当然这里其实处理了很多的逻辑，包括对图片的压缩，甚至还有旋转、圆角等逻辑处理，但是我们目前只需要关注主线逻辑就行了。</p>
<p>decode()方法执行之后，会返回一个Bitmap对象，那么图片在这里其实也就已经被加载出来了，剩下的工作就是如果让这个Bitmap显示到界面上，我们继续往下分析。</p>
<p>回到刚才的StreamBitmapDecoder当中，你会发现，它的decode()方法返回的是一个Resource&lt; Bitmap&gt;对象。</p>
<p>而我们从Downsampler中得到的是一个Bitmap对象，因此这里在第18行又调用了BitmapResource.obtain()方法，将Bitmap对象包装成了Resource&lt; Bitmap&gt;对象。代码如下所示：</p>
<h3 id="BitmapResource"><a href="#BitmapResource" class="headerlink" title="BitmapResource"></a>BitmapResource</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapResource</span> <span class="keyword">implements</span> <span class="title">Resource</span>&lt;<span class="title">Bitmap</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BitmapPool bitmapPool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a new &#123;<span class="doctag">@link</span> BitmapResource&#125; wrapping the given &#123;<span class="doctag">@link</span> Bitmap&#125; if the Bitmap is non-null or null if the</span></span><br><span class="line"><span class="comment">     * given Bitmap is null.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bitmap A Bitmap.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bitmapPool A non-null &#123;<span class="doctag">@link</span> BitmapPool&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">BitmapResource <span class="title">obtain</span><span class="params">(Bitmap bitmap, BitmapPool bitmapPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BitmapResource(bitmap, bitmapPool);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapResource</span><span class="params">(Bitmap bitmap, BitmapPool bitmapPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Bitmap must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bitmapPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"BitmapPool must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.bitmap = bitmap;</span><br><span class="line">        <span class="keyword">this</span>.bitmapPool = bitmapPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Bitmap <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Util.<span class="title">getBitmapByteSize</span><span class="params">(bitmap)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!bitmapPool.put(bitmap)) &#123;</span><br><span class="line">            bitmap.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BitmapResource的源码也非常简单，经过这样一层包装之后，如果我还需要获取Bitmap，只需要调用Resource<bitmap>的get()方法就可以了。</bitmap></p>
<p>然后我们需要一层层继续向上返回，StreamBitmapDecoder会将值返回到ImageVideoBitmapDecoder当中，而ImageVideoBitmapDecoder又会将值返回到GifBitmapWrapperResourceDecoder的decodeBitmapWrapper()方法当中。</p>
<p>由于代码隔得有点太远了，我重新把decodeBitmapWrapper()方法的代码贴一下：</p>
<h3 id="decodeBitmapWrapper"><a href="#decodeBitmapWrapper" class="headerlink" title="decodeBitmapWrapper"></a>decodeBitmapWrapper</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> GifBitmapWrapper decodeBitmapWrapper(ImageVideoWrapper toDecode, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    GifBitmapWrapper result = <span class="keyword">null</span>;</span><br><span class="line">    Resource&lt;Bitmap&gt; bitmapResource = bitmapDecoder.decode(toDecode, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">    <span class="keyword">if</span> (bitmapResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> GifBitmapWrapper(bitmapResource, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，decodeBitmapWrapper()方法返回的是一个GifBitmapWrapper对象。因此，这里在第5行，又将Resource&lt; Bitmap&gt;封装到了一个GifBitmapWrapper对象当中。这个GifBitmapWrapper顾名思义，就是既能封装GIF，又能封装Bitmap，从而保证了不管是什么类型的图片Glide都能从容应对。</p>
<p>我们顺便来看下GifBitmapWrapper的源码吧，如下所示：</p>
<h3 id="GifBitmapWrapper"><a href="#GifBitmapWrapper" class="headerlink" title="GifBitmapWrapper"></a>GifBitmapWrapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GifBitmapWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Resource&lt;GifDrawable&gt; gifResource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Resource&lt;Bitmap&gt; bitmapResource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GifBitmapWrapper</span><span class="params">(Resource&lt;Bitmap&gt; bitmapResource, Resource&lt;GifDrawable&gt; gifResource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapResource != <span class="keyword">null</span> &amp;&amp; gifResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can only contain either a bitmap resource or a gif resource, not both"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bitmapResource == <span class="keyword">null</span> &amp;&amp; gifResource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Must contain either a bitmap resource or a gif resource"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.bitmapResource = bitmapResource;</span><br><span class="line">        <span class="keyword">this</span>.gifResource = gifResource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the size of the wrapped resource.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> bitmapResource.getSize();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> gifResource.getSize();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the wrapped &#123;<span class="doctag">@link</span> Bitmap&#125; resource if it exists, or null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;Bitmap&gt; <span class="title">getBitmapResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bitmapResource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the wrapped &#123;<span class="doctag">@link</span> GifDrawable&#125; resource if it exists, or null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;GifDrawable&gt; <span class="title">getGifResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gifResource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别对gifResource和bitmapResource做了一层封装而已</p>
<p>然后这个GifBitmapWrapper对象会一直向上返回，返回到GifBitmapWrapperResourceDecoder最外层的decode()方法的时候，会对它再做一次封装，如下所示：</p>
<h3 id="decode-1"><a href="#decode-1" class="headerlink" title="decode"></a>decode</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Resource&lt;GifBitmapWrapper&gt; decode(ImageVideoWrapper source, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ByteArrayPool pool = ByteArrayPool.<span class="built_in">get</span>();</span><br><span class="line">    <span class="built_in">byte</span>[] tempBytes = pool.getBytes();</span><br><span class="line">    GifBitmapWrapper wrapper = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        wrapper = decode(source, <span class="built_in">width</span>, <span class="built_in">height</span>, tempBytes);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        pool.releaseBytes(tempBytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> wrapper != <span class="keyword">null</span> ? <span class="keyword">new</span> GifBitmapWrapperResource(wrapper) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第11行，又将GifBitmapWrapper封装到了一个GifBitmapWrapperResource对象当中，最终返回的是一个Resource&lt; GifBitmapWrapper&gt;对象。这个GifBitmapWrapperResource和刚才的BitmapResource是相似的，它们都实现的Resource接口，都可以通过get()方法来获取封装起来的具体内容。</p>
<h3 id="GifBitmapWrapperResource"><a href="#GifBitmapWrapperResource" class="headerlink" title="GifBitmapWrapperResource"></a>GifBitmapWrapperResource</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GifBitmapWrapperResource</span> <span class="title">implements</span> <span class="title">Resource</span>&lt;<span class="type">GifBitmapWrapper</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GifBitmapWrapper <span class="keyword">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GifBitmapWrapperResource(GifBitmapWrapper <span class="keyword">data</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">data</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new NullPointerException(<span class="string">"Data must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">data</span> = <span class="keyword">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GifBitmapWrapper <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> int getSize() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">data</span>.getSize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void recycle() &#123;</span><br><span class="line">        Resource&lt;Bitmap&gt; bitmapResource = <span class="keyword">data</span>.getBitmapResource();</span><br><span class="line">        <span class="keyword">if</span> (bitmapResource != <span class="literal">null</span>) &#123;</span><br><span class="line">            bitmapResource.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        Resource&lt;GifDrawable&gt; gifDataResource = <span class="keyword">data</span>.getGifResource();</span><br><span class="line">        <span class="keyword">if</span> (gifDataResource != <span class="literal">null</span>) &#123;</span><br><span class="line">            gifDataResource.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过这一层的封装之后，我们从网络上得到的图片就能够以Resource接口的形式返回，并且还能同时处理Bitmap图片和GIF图片这两种情况。</p>
<p>现在我们可以回到DecodeJob当中了，它的decodeFromSourceData()方法返回的是一个Resource&lt; T&gt;对象，其实也就是Resource&lt; GifBitmapWrapper&gt;对象了。然后继续向上返回，最终返回到decodeFromSource()方法当中，如下所示：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Resource&lt;Z&gt; decodeFromSource() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Resource&lt;T&gt; decoded = decodeSource();</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">transformEncodeAndTranscode</span><span class="params">(decoded)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们就是从这里跟进到decodeSource()方法当中，然后执行了一大堆一大堆的逻辑，最终得到了这个Resource&lt; T&gt;对象。</p>
<p>然而你会发现，decodeFromSource()方法最终返回的却是一个Resource&lt; Z&gt;对象，那么这到底是怎么回事呢？</p>
<h3 id="transformEncodeAndTranscode"><a href="#transformEncodeAndTranscode" class="headerlink" title="transformEncodeAndTranscode"></a>transformEncodeAndTranscode</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Resource&lt;Z&gt; transformEncodeAndTranscode(Resource&lt;T&gt; decoded) &#123;</span><br><span class="line">    long startTime = LogTime.getLogTime();</span><br><span class="line">    Resource&lt;T&gt; transformed = transform(decoded);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">Log</span>.isLoggable(<span class="built_in">TAG</span>, <span class="keyword">Log</span>.VERBOSE)) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Transformed resource from source"</span>, startTime);</span><br><span class="line">    &#125;</span><br><span class="line">    writeTransformedToCache(transformed);</span><br><span class="line">    startTime = LogTime.getLogTime();</span><br><span class="line">    Resource&lt;Z&gt; result = transcode(transformed);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">Log</span>.isLoggable(<span class="built_in">TAG</span>, <span class="keyword">Log</span>.VERBOSE)) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Transcoded transformed from source"</span>, startTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Resource&lt;Z&gt; transcode(Resource&lt;T&gt; transformed) &#123;</span><br><span class="line">    <span class="keyword">if</span> (transformed == <span class="built_in">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transcoder.transcode(transformed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，这个方法开头的几行transform还有cache，这都是我们后面才会学习的东西，现在不用管它们就可以了。需要注意的是第9行，这里调用了一个transcode()方法，就把Resource&lt; T&gt;对象转换成Resource&lt; Z&gt;对象了。</p>
<p>而transcode()方法中又是调用了transcoder的transcode()方法，那么这个transcoder是什么呢？其实这也是Glide源码特别难懂的原因之一，就是它用到的很多对象都是很早很早之前就初始化的，在初始化的时候你可能完全就没有留意过它，因为一时半会根本就用不着，但是真正需要用到的时候你却早就记不起来这个对象是从哪儿来的了。</p>
<p>那么这里我来提醒一下大家吧，在第二步load()方法返回的那个DrawableTypeRequest对象，它的构建函数中去构建了一个FixedLoadProvider对象，然后我们将三个参数传入到了FixedLoadProvider当中，其中就有一个GifBitmapWrapperDrawableTranscoder对象。后来在onSizeReady()方法中获取到了这个参数，并传递到了Engine当中，然后又由Engine传递到了DecodeJob当中。因此，这里的transcoder其实就是这个GifBitmapWrapperDrawableTranscoder对象。</p>
<h3 id="GifBitmapWrapperDrawableTranscoder"><a href="#GifBitmapWrapperDrawableTranscoder" class="headerlink" title="GifBitmapWrapperDrawableTranscoder"></a>GifBitmapWrapperDrawableTranscoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GifBitmapWrapperDrawableTranscoder</span> <span class="keyword">implements</span> <span class="title">ResourceTranscoder</span>&lt;<span class="title">GifBitmapWrapper</span>, <span class="title">GlideDrawable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceTranscoder&lt;Bitmap, GlideBitmapDrawable&gt; bitmapDrawableResourceTranscoder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GifBitmapWrapperDrawableTranscoder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ResourceTranscoder&lt;Bitmap, GlideBitmapDrawable&gt; bitmapDrawableResourceTranscoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bitmapDrawableResourceTranscoder = bitmapDrawableResourceTranscoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;GlideDrawable&gt; <span class="title">transcode</span><span class="params">(Resource&lt;GifBitmapWrapper&gt; toTranscode)</span> </span>&#123;</span><br><span class="line">        GifBitmapWrapper gifBitmap = toTranscode.get();</span><br><span class="line">        Resource&lt;Bitmap&gt; bitmapResource = gifBitmap.getBitmapResource();</span><br><span class="line">        <span class="keyword">final</span> Resource&lt;? extends GlideDrawable&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (bitmapResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = bitmapDrawableResourceTranscoder.transcode(bitmapResource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = gifBitmap.getGifResource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (Resource&lt;GlideDrawable&gt;) result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GifBitmapWrapperDrawableTranscoder的核心作用就是用来转码的。因为GifBitmapWrapper是无法直接显示到ImageView上面的，只有Bitmap或者Drawable才能显示到ImageView上。因此，这里的transcode()方法先从Resource&lt; GifBitmapWrapper&gt;中取出GifBitmapWrapper对象，然后再从GifBitmapWrapper中取出Resource&lt; Bitmap&gt;对象。</p>
<p>接下来做了一个判断，如果Resource&lt; Bitmap&gt;为空，那么说明此时加载的是GIF图，直接调用getGifResource()方法将图片取出即可，因为Glide用于加载GIF图片是使用的GifDrawable这个类，它本身就是一个Drawable对象了。而如果Resource&lt; Bitmap&gt;不为空，那么就需要再做一次转码，将Bitmap转换成Drawable对象才行，因为要保证静图和动图的类型一致性，不然逻辑上是不好处理的。</p>
<p>这里在第15行又进行了一次转码，是调用的GlideBitmapDrawableTranscoder对象的transcode()方法</p>
<h3 id="GlideBitmapDrawableTranscoder"><a href="#GlideBitmapDrawableTranscoder" class="headerlink" title="GlideBitmapDrawableTranscoder"></a>GlideBitmapDrawableTranscoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlideBitmapDrawableTranscoder</span> <span class="keyword">implements</span> <span class="title">ResourceTranscoder</span>&lt;<span class="title">Bitmap</span>, <span class="title">GlideBitmapDrawable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Resources resources;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BitmapPool bitmapPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GlideBitmapDrawableTranscoder</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context.getResources(), Glide.get(context).getBitmapPool());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GlideBitmapDrawableTranscoder</span><span class="params">(Resources resources, BitmapPool bitmapPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resources = resources;</span><br><span class="line">        <span class="keyword">this</span>.bitmapPool = bitmapPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource&lt;GlideBitmapDrawable&gt; <span class="title">transcode</span><span class="params">(Resource&lt;Bitmap&gt; toTranscode)</span> </span>&#123;</span><br><span class="line">        GlideBitmapDrawable drawable = <span class="keyword">new</span> GlideBitmapDrawable(resources, toTranscode.get());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GlideBitmapDrawableResource(drawable, bitmapPool);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里new出了一个GlideBitmapDrawable对象，并把Bitmap封装到里面。然后对GlideBitmapDrawable再进行一次封装，返回一个Resource&lt; GlideBitmapDrawable&gt;对象。</p>
<p>现在再返回到GifBitmapWrapperDrawableTranscoder的transcode()方法中，你会发现它们的类型就一致了。因为不管是静图的Resource&lt; GlideBitmapDrawable&gt;对象，还是动图的Resource&lt; GifDrawable&gt;对象，它们都是属于父类Resource&lt; GlideDrawable&gt;对象的。因此transcode()方法也是直接返回了Resource&lt; GlideDrawable&gt;，而这个Resource&lt; GlideDrawable&gt;其实也就是转换过后的Resource&lt; Z&gt;了。</p>
<p>那么我们继续回到DecodeJob当中，它的decodeFromSource()方法得到了Resource&lt; Z&gt;对象，当然也就是Resource&lt; GlideDrawable&gt;对象。然后继续向上返回会回到EngineRunnable的decodeFromSource()方法，再回到decode()方法，再回到run()方法当中。那么我们重新再贴一下EngineRunnable run()方法的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> void run() &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Exception</span> <span class="keyword">exception</span> = <span class="keyword">null</span>;</span><br><span class="line">    Resource<span class="meta">&lt;?</span>&gt; resource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        resource = decode();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Exception decoding"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exception</span> = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resource.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resource == <span class="keyword">null</span>) &#123;</span><br><span class="line">        onLoadFailed(<span class="keyword">exception</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onLoadComplete(resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过第9行decode()方法的执行，我们最终得到了这个Resource&lt; GlideDrawable&gt;对象，那么接下来就是如何将它显示出来了。可以看到，这里在第25行调用了onLoadComplete()方法，表示图片加载已经完成了，代码如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onLoadComplete</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">    manager.onResourceReady(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个manager就是EngineJob对象，因此这里实际上调用的是EngineJob的onResourceReady()方法</p>
<h3 id="onResourceReady"><a href="#onResourceReady" class="headerlink" title="onResourceReady"></a>onResourceReady</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EngineJob</span> <span class="keyword">implements</span> <span class="title">EngineRunnable</span>.<span class="title">EngineRunnableManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Handler MAIN_THREAD_HANDLER = <span class="keyword">new</span> Handler(Looper.getMainLooper(), <span class="keyword">new</span> MainThreadCallback());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResourceCallback&gt; cbs = <span class="keyword">new</span> ArrayList&lt;ResourceCallback&gt;();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCallback</span><span class="params">(ResourceCallback cb)</span> </span>&#123;</span><br><span class="line">        Util.assertMainThread();</span><br><span class="line">        <span class="keyword">if</span> (hasResource) &#123;</span><br><span class="line">            cb.onResourceReady(engineResource);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasException) &#123;</span><br><span class="line">            cb.onException(exception);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(<span class="keyword">final</span> Resource&lt;?&gt; resource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resource = resource;</span><br><span class="line">        MAIN_THREAD_HANDLER.obtainMessage(MSG_COMPLETE, <span class="keyword">this</span>).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleResultOnMainThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">            resource.recycle();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cbs.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Received a resource without any callbacks to notify"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        engineResource = engineResourceFactory.build(resource, isCacheable);</span><br><span class="line">        hasResource = <span class="keyword">true</span>;</span><br><span class="line">        engineResource.acquire();</span><br><span class="line">        listener.onEngineJobComplete(key, engineResource);</span><br><span class="line">        <span class="keyword">for</span> (ResourceCallback cb : cbs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isInIgnoredCallbacks(cb)) &#123;</span><br><span class="line">                engineResource.acquire();</span><br><span class="line">                cb.onResourceReady(engineResource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        engineResource.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exception = e;</span><br><span class="line">        MAIN_THREAD_HANDLER.obtainMessage(MSG_EXCEPTION, <span class="keyword">this</span>).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleExceptionOnMainThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cbs.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Received an exception without any callbacks to notify"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        hasException = <span class="keyword">true</span>;</span><br><span class="line">        listener.onEngineJobComplete(key, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (ResourceCallback cb : cbs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isInIgnoredCallbacks(cb)) &#123;</span><br><span class="line">                cb.onException(exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainThreadCallback</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (MSG_COMPLETE == message.what || MSG_EXCEPTION == message.what) &#123;</span><br><span class="line">                EngineJob job = (EngineJob) message.obj;</span><br><span class="line">                <span class="keyword">if</span> (MSG_COMPLETE == message.what) &#123;</span><br><span class="line">                    job.handleResultOnMainThread();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    job.handleExceptionOnMainThread();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里在onResourceReady()方法使用Handler发出了一条MSG_COMPLETE消息，那么在MainThreadCallback的handleMessage()方法中就会收到这条消息。从这里开始，所有的逻辑又回到主线程当中进行了，因为很快就需要更新UI了。</p>
<p>然后在第72行调用了handleResultOnMainThread()方法，这个方法中又通过一个循环，调用了所有ResourceCallback的onResourceReady()方法。那么这个ResourceCallback是什么呢？答案在addCallback()方法当中，它会向cbs集合中去添加ResourceCallback。那么这个addCallback()方法又是哪里调用的呢？其实调用的地方我们早就已经看过了，只不过之前没有注意，现在重新来看一下Engine的load()方法</p>
<h3 id="load-2"><a href="#load-2" class="headerlink" title="load"></a>load</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Engine implements EngineJobListener,</span><br><span class="line">        MemoryCache.ResourceRemovedListener,</span><br><span class="line">        EngineResource.ResourceListener &#123;</span><br><span class="line"></span><br><span class="line">    ...    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T, Z, R&gt; LoadStatus load(Key signature, <span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>, DataFetcher&lt;T&gt; fetcher,</span><br><span class="line">            DataLoadProvider&lt;T, Z&gt; loadProvider, Transformation&lt;Z&gt; transformation, ResourceTranscoder&lt;Z, R&gt; transcoder, Priority priority, </span><br><span class="line">            <span class="built_in">boolean</span> isMemoryCacheable, DiskCacheStrategy diskCacheStrategy, ResourceCallback cb) &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        EngineJob engineJob = engineJobFactory.build(<span class="built_in">key</span>, isMemoryCacheable);</span><br><span class="line">        DecodeJob&lt;T, Z, R&gt; decodeJob = <span class="keyword">new</span> DecodeJob&lt;T, Z, R&gt;(<span class="built_in">key</span>, <span class="built_in">width</span>, <span class="built_in">height</span>, fetcher, loadProvider, transformation,</span><br><span class="line">                transcoder, diskCacheProvider, diskCacheStrategy, priority);</span><br><span class="line">        EngineRunnable runnable = <span class="keyword">new</span> EngineRunnable(engineJob, decodeJob, priority);</span><br><span class="line">        jobs.put(<span class="built_in">key</span>, engineJob);</span><br><span class="line">        engineJob.addCallback(cb);</span><br><span class="line">        engineJob.start(runnable);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logWithTimeAndKey(<span class="string">"Started new load"</span>, startTime, <span class="built_in">key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第18行上面，看到了吗？就是在这里调用的EngineJob的addCallback()方法来注册的一个ResourceCallback。那么接下来的问题就是，Engine.load()方法的ResourceCallback参数又是谁传过来的呢？这就需要回到GenericRequest的onSizeReady()方法当中了，我们看到ResourceCallback是load()方法的最后一个参数，那么在onSizeReady()方法中调用load()方法时传入的最后一个参数是什么？代码如下所示：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> class GenericRequest&lt;A, T, Z, R&gt; implements Request, SizeReadyCallback,</span><br><span class="line">        ResourceCallback &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onSizeReady(<span class="built_in">int</span> <span class="built_in">width</span>, <span class="built_in">int</span> <span class="built_in">height</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"Got onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        status = Status.RUNNING;</span><br><span class="line">        <span class="built_in">width</span> = Math.<span class="built_in">round</span>(sizeMultiplier * <span class="built_in">width</span>);</span><br><span class="line">        <span class="built_in">height</span> = Math.<span class="built_in">round</span>(sizeMultiplier * <span class="built_in">height</span>);</span><br><span class="line">        ModelLoader&lt;A, T&gt; modelLoader = loadProvider.getModelLoader();</span><br><span class="line">        <span class="keyword">final</span> DataFetcher&lt;T&gt; dataFetcher = modelLoader.getResourceFetcher(model, <span class="built_in">width</span>, <span class="built_in">height</span>);</span><br><span class="line">        <span class="keyword">if</span> (dataFetcher == <span class="keyword">null</span>) &#123;</span><br><span class="line">            onException(<span class="keyword">new</span> Exception(<span class="string">"Failed to load model: \'"</span> + model + <span class="string">"\'"</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ResourceTranscoder&lt;Z, R&gt; transcoder = loadProvider.getTranscoder();</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"finished setup for calling load in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">        loadedFromMemoryCache = <span class="keyword">true</span>;</span><br><span class="line">        loadStatus = engine.load(signature, <span class="built_in">width</span>, <span class="built_in">height</span>, dataFetcher, loadProvider, transformation, </span><br><span class="line">                transcoder, priority, isMemoryCacheable, diskCacheStrategy, <span class="keyword">this</span>);</span><br><span class="line">        loadedFromMemoryCache = resource != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"finished onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请将目光锁定在第29行的最后一个参数，this。没错，就是this。GenericRequest本身就实现了ResourceCallback的接口，因此EngineJob的回调最终其实就是回调到了GenericRequest的onResourceReady()方法当中了</p>
<h3 id="onResourceReady-1"><a href="#onResourceReady-1" class="headerlink" title="onResourceReady"></a>onResourceReady</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (resource == <span class="keyword">null</span>) &#123;</span><br><span class="line">        onException(<span class="keyword">new</span> Exception(<span class="string">"Expected to receive a Resource&lt;R&gt; with an object of "</span> + transcodeClass</span><br><span class="line">                + <span class="string">" inside, but instead got null."</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Object received = resource.get();</span><br><span class="line">    <span class="keyword">if</span> (received == <span class="keyword">null</span> || !transcodeClass.isAssignableFrom(received.getClass())) &#123;</span><br><span class="line">        releaseResource(resource);</span><br><span class="line">        onException(<span class="keyword">new</span> Exception(<span class="string">"Expected to receive an object of "</span> + transcodeClass</span><br><span class="line">                + <span class="string">" but instead got "</span> + (received != <span class="keyword">null</span> ? received.getClass() : <span class="string">""</span>) + <span class="string">"&#123;"</span> + received + <span class="string">"&#125;"</span></span><br><span class="line">                + <span class="string">" inside Resource&#123;"</span> + resource + <span class="string">"&#125;."</span></span><br><span class="line">                + (received != <span class="keyword">null</span> ? <span class="string">""</span> : <span class="string">" "</span></span><br><span class="line">                    + <span class="string">"To indicate failure return a null Resource object, "</span></span><br><span class="line">                    + <span class="string">"rather than a Resource object containing null data."</span>)</span><br><span class="line">        ));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!canSetResource()) &#123;</span><br><span class="line">        releaseResource(resource);</span><br><span class="line">        <span class="comment">// We can't set the status to complete before asking canSetResource().</span></span><br><span class="line">        status = Status.COMPLETE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onResourceReady(resource, (R) received);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource, R result)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We must call isFirstReadyResource before setting status.</span></span><br><span class="line">    <span class="keyword">boolean</span> isFirstResource = isFirstReadyResource();</span><br><span class="line">    status = Status.COMPLETE;</span><br><span class="line">    <span class="keyword">this</span>.resource = resource;</span><br><span class="line">    <span class="keyword">if</span> (requestListener == <span class="keyword">null</span> || !requestListener.onResourceReady(result, model, <span class="keyword">target</span>, loadedFromMemoryCache,</span><br><span class="line">            isFirstResource)) &#123;</span><br><span class="line">        GlideAnimation&lt;R&gt; animation = animationFactory.build(loadedFromMemoryCache, isFirstResource);</span><br><span class="line">        <span class="keyword">target</span>.onResourceReady(result, animation);</span><br><span class="line">    &#125;</span><br><span class="line">    notifyLoadSuccess();</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        logV(<span class="string">"Resource ready in "</span> + LogTime.getElapsedMillis(startTime) + <span class="string">" size: "</span></span><br><span class="line">                + (resource.getSize() * TO_MEGABYTE) + <span class="string">" fromCache: "</span> + loadedFromMemoryCache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个onResourceReady()方法，首先在第一个onResourceReady()方法当中，调用resource.get()方法获取到了封装的图片对象，也就是GlideBitmapDrawable对象，或者是GifDrawable对象。然后将这个值传入到了第二个onResourceReady()方法当中，并在第36行调用了target.onResourceReady()方法。</p>
<p>那么这个target又是什么呢？这个又需要向上翻很久了，在第三步into()方法的一开始，我们就分析了在into()方法的最后一行，调用了glide.buildImageViewTarget()方法来构建出一个Target，而这个Target就是一个GlideDrawableImageViewTarget对象。</p>
<h3 id="GlideDrawableImageViewTarget"><a href="#GlideDrawableImageViewTarget" class="headerlink" title="GlideDrawableImageViewTarget"></a>GlideDrawableImageViewTarget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlideDrawableImageViewTarget</span> <span class="keyword">extends</span> <span class="title">ImageViewTarget</span>&lt;<span class="title">GlideDrawable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> SQUARE_RATIO_MARGIN = <span class="number">0.05f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxLoopCount;</span><br><span class="line">    <span class="keyword">private</span> GlideDrawable resource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GlideDrawableImageViewTarget</span><span class="params">(ImageView view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(view, GlideDrawable.LOOP_FOREVER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GlideDrawableImageViewTarget</span><span class="params">(ImageView view, <span class="keyword">int</span> maxLoopCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(view);</span><br><span class="line">        <span class="keyword">this</span>.maxLoopCount = maxLoopCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(GlideDrawable resource, GlideAnimation&lt;? <span class="keyword">super</span> GlideDrawable&gt; animation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!resource.isAnimated()) &#123;</span><br><span class="line">            <span class="keyword">float</span> viewRatio = view.getWidth() / (<span class="keyword">float</span>) view.getHeight();</span><br><span class="line">            <span class="keyword">float</span> drawableRatio = resource.getIntrinsicWidth() / (<span class="keyword">float</span>) resource.getIntrinsicHeight();</span><br><span class="line">            <span class="keyword">if</span> (Math.abs(viewRatio - <span class="number">1f</span>) &lt;= SQUARE_RATIO_MARGIN</span><br><span class="line">                    &amp;&amp; Math.abs(drawableRatio - <span class="number">1f</span>) &lt;= SQUARE_RATIO_MARGIN) &#123;</span><br><span class="line">                resource = <span class="keyword">new</span> SquaringDrawable(resource, view.getWidth());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onResourceReady(resource, animation);</span><br><span class="line">        <span class="keyword">this</span>.resource = resource;</span><br><span class="line">        resource.setLoopCount(maxLoopCount);</span><br><span class="line">        resource.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(GlideDrawable resource)</span> </span>&#123;</span><br><span class="line">        view.setImageDrawable(resource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resource.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resource.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在GlideDrawableImageViewTarget的onResourceReady()方法中做了一些逻辑处理，包括如果是GIF图片的话，就调用resource.start()方法开始播放图片，但是好像并没有看到哪里有将GlideDrawable显示到ImageView上的逻辑。</p>
<p>确实没有，不过父类里面有，这里在第25行调用了super.onResourceReady()方法，GlideDrawableImageViewTarget的父类是ImageViewTarget，我们来看下它的代码吧：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTarget&lt;Z&gt;</span> <span class="keyword">extends</span> <span class="title">ViewTarget&lt;ImageView</span>, <span class="title">Z&gt;</span> <span class="title">implements</span> <span class="title">GlideAnimation</span>.<span class="title">ViewAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void onResourceReady(<span class="type">Z</span> resource, <span class="type">GlideAnimation</span>&lt;? <span class="keyword">super</span> <span class="type">Z</span>&gt; glideAnimation) &#123;</span><br><span class="line">        <span class="keyword">if</span> (glideAnimation == <span class="literal">null</span> || !glideAnimation.animate(resource, <span class="keyword">this</span>)) &#123;</span><br><span class="line">            setResource(resource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> void setResource(<span class="type">Z</span> resource);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在ImageViewTarget的onResourceReady()方法当中调用了setResource()方法，而ImageViewTarget的setResource()方法是一个抽象方法，具体的实现还是在子类那边实现的。</p>
<p>那子类的setResource()方法是怎么实现的呢？回头再来看一下GlideDrawableImageViewTarget的setResource()方法，没错，调用的view.setImageDrawable()方法，而这个view就是ImageView。代码执行到这里，图片终于也就显示出来了。</p>
<p>那么，我们对Glide执行流程的源码分析，到这里也终于结束了。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Glide/" rel="tag"># Glide</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/20/OkHttp-4/" rel="next" title="OkHttp3(4)">
                <i class="fa fa-chevron-left"></i> OkHttp3(4)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/20/Glide-2/" rel="prev" title="Glide-2">
                Glide-2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNzc1OS8xNDI5MA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Wakaka</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
<br>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 
src="//music.163.com/outchain/player?type=2&id=428423168&auto=1&height=66"></iframe>

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#with"><span class="nav-number">1.</span> <span class="nav-text">with()</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#load"><span class="nav-number">2.</span> <span class="nav-text">load()</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#load-方法"><span class="nav-number">2.1.</span> <span class="nav-text">load()方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loadGeneric-方法"><span class="nav-number">2.2.</span> <span class="nav-text">loadGeneric()方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestManager源码"><span class="nav-number">2.3.</span> <span class="nav-text">RequestManager源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestBuilder"><span class="nav-number">2.4.</span> <span class="nav-text">RequestBuilder</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#into"><span class="nav-number">3.</span> <span class="nav-text">into()</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestBuilder中的into-方法"><span class="nav-number">3.1.</span> <span class="nav-text">RequestBuilder中的into()方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#buildImageViewTarget"><span class="nav-number">3.1.1.</span> <span class="nav-text">buildImageViewTarget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ImageViewTargetFactory"><span class="nav-number">3.1.2.</span> <span class="nav-text">ImageViewTargetFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buildRequest"><span class="nav-number">3.1.3.</span> <span class="nav-text">buildRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#begin"><span class="nav-number">3.1.4.</span> <span class="nav-text">begin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setErrorPlaceholder"><span class="nav-number">3.1.5.</span> <span class="nav-text">setErrorPlaceholder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onSizeReady"><span class="nav-number">3.1.6.</span> <span class="nav-text">onSizeReady</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#load-1"><span class="nav-number">3.1.7.</span> <span class="nav-text">load()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run"><span class="nav-number">3.1.8.</span> <span class="nav-text">run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#decode"><span class="nav-number">3.1.9.</span> <span class="nav-text">decode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#decodeFromSource"><span class="nav-number">3.1.10.</span> <span class="nav-text">decodeFromSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#decodeFromSourceData"><span class="nav-number">3.1.11.</span> <span class="nav-text">decodeFromSourceData</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GifBitmapWrapperResourceDecoder"><span class="nav-number">3.1.12.</span> <span class="nav-text">GifBitmapWrapperResourceDecoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ImageVideoBitmapDecoder"><span class="nav-number">3.1.13.</span> <span class="nav-text">ImageVideoBitmapDecoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StreamBitmapDecoder"><span class="nav-number">3.1.14.</span> <span class="nav-text">StreamBitmapDecoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Downsampler"><span class="nav-number">3.1.15.</span> <span class="nav-text">Downsampler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BitmapResource"><span class="nav-number">3.1.16.</span> <span class="nav-text">BitmapResource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#decodeBitmapWrapper"><span class="nav-number">3.1.17.</span> <span class="nav-text">decodeBitmapWrapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GifBitmapWrapper"><span class="nav-number">3.1.18.</span> <span class="nav-text">GifBitmapWrapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#decode-1"><span class="nav-number">3.1.19.</span> <span class="nav-text">decode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GifBitmapWrapperResource"><span class="nav-number">3.1.20.</span> <span class="nav-text">GifBitmapWrapperResource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#transformEncodeAndTranscode"><span class="nav-number">3.1.21.</span> <span class="nav-text">transformEncodeAndTranscode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GifBitmapWrapperDrawableTranscoder"><span class="nav-number">3.1.22.</span> <span class="nav-text">GifBitmapWrapperDrawableTranscoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GlideBitmapDrawableTranscoder"><span class="nav-number">3.1.23.</span> <span class="nav-text">GlideBitmapDrawableTranscoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onResourceReady"><span class="nav-number">3.1.24.</span> <span class="nav-text">onResourceReady</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#load-2"><span class="nav-number">3.1.25.</span> <span class="nav-text">load</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onResourceReady-1"><span class="nav-number">3.1.26.</span> <span class="nav-text">onResourceReady</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GlideDrawableImageViewTarget"><span class="nav-number">3.1.27.</span> <span class="nav-text">GlideDrawableImageViewTarget</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wakaka</span>

  
</div>

<div class="powered-by">
  <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
    本站访客数:<span id="busuanzi_value_site_uv"></span>
  </span>
</div>

<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
 

  <span class="post-meta-divider">|</span>



  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
