<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Retrofit2," />










<meta name="description" content="用途 Retrofit is the class through which your API interfaces are turned into callable objects. 译：Retrofit通过设置的API接口转换为可以被调用的类。  所以，这样我们就可以知道Retrofit是一个HTTP框架，那么在没有Retrofit之前，我们是如何请求的。">
<meta name="keywords" content="Retrofit2">
<meta property="og:type" content="article">
<meta property="og:title" content="Retrofit2(1)">
<meta property="og:url" content="http://yoursite.com/2018/06/28/Retrofit2-1/index.html">
<meta property="og:site_name" content="Wakaka">
<meta property="og:description" content="用途 Retrofit is the class through which your API interfaces are turned into callable objects. 译：Retrofit通过设置的API接口转换为可以被调用的类。  所以，这样我们就可以知道Retrofit是一个HTTP框架，那么在没有Retrofit之前，我们是如何请求的。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/625299-e0f8fda2d0855996.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700">
<meta property="og:updated_time" content="2018-07-22T07:05:58.390Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Retrofit2(1)">
<meta name="twitter:description" content="用途 Retrofit is the class through which your API interfaces are turned into callable objects. 译：Retrofit通过设置的API接口转换为可以被调用的类。  所以，这样我们就可以知道Retrofit是一个HTTP框架，那么在没有Retrofit之前，我们是如何请求的。">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/625299-e0f8fda2d0855996.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/06/28/Retrofit2-1/"/>





  <title>Retrofit2(1) | Wakaka</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	
	<a href="https://github.com/bingweibi">
	<img style="position: absolute; top: 0; right: 0; border: 0;" 
	src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" 
	alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wakaka</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">路漫漫其修远兮，吾将上下而求索</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/28/Retrofit2-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wakaka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wakaka">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Retrofit2(1)</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-28T15:38:19+08:00">
                2018-06-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h1><blockquote>
<p>Retrofit is the class through which your API interfaces are turned into callable objects.</p>
<p>译：Retrofit通过设置的API接口转换为可以被调用的类。</p>
</blockquote>
<p>所以，这样我们就可以知道Retrofit是一个HTTP框架，那么在没有Retrofit之前，我们是如何请求的。</p>
<center><img src="https://upload-images.jianshu.io/upload_images/625299-e0f8fda2d0855996.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></center>

<a id="more"></a>
<ol>
<li>build Request参数</li>
<li>因为网络请求是一个耗时操作，Android不允许在主线程中进行，所以需要线程或利用Excutor创建新线程</li>
<li>异步后，通过运行非主线程来进行网络请求</li>
<li>请求成功，获取到服务器返回的数据之后，callback回调给应用上层</li>
<li>进行切换线程，数据处理等等</li>
</ol>
<h1 id="发展历程"><a href="#发展历程" class="headerlink" title="发展历程"></a>发展历程</h1><ol>
<li>手写上述过程</li>
<li>官方出了AsyncTask</li>
<li>第三方库Volly…</li>
</ol>
<p>优缺点、对比什么的就先挖个坑</p>
<h1 id="Retrofit"><a href="#Retrofit" class="headerlink" title="Retrofit"></a>Retrofit</h1><p>接下来我们来看看Retrofit有什么能力取代其他框架的。</p>
<h2 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h2><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Retrofit</span> retrofit = <span class="function"><span class="keyword">new</span> <span class="title">Retrofit</span>.<span class="title">Builder</span>()</span></span><br><span class="line"><span class="function">            .<span class="title">client</span>(okHttpClient)</span></span><br><span class="line"><span class="function">            .<span class="title">baseUrl</span>("http://news-at.zhihu.com/")</span></span><br><span class="line"><span class="function">            .<span class="title">addConverterFactory</span>(gsonConverterFactory)</span></span><br><span class="line"><span class="function">            .<span class="title">addCallAdapterFactory</span>(rxJavaCallAdapterFactory)</span></span><br><span class="line"><span class="function">            .<span class="title">build</span>();</span></span><br><span class="line"><span class="function">    <span class="title">zhiHuApi</span> = <span class="title">retrofit</span>.<span class="title">create</span>(<span class="type">ZhiHuApi</span>.class);</span></span><br></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">ZhiHuApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">"api/4/news/latest"</span>)</span><br><span class="line">    Observable&lt;ZhiHu&gt; getStoriesInfo();</span><br><span class="line"></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">"api/4/news/before/&#123;date&#125;"</span>)</span><br><span class="line">    Observable&lt;ZhiHu&gt; getOldStoriesInfo(<span class="variable">@Path</span>(<span class="string">"date"</span>) String date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h2><p>前面叙述了没有 Retrofit 是如何进行网络请求的，那我们按照给出步骤来看看Retrofit是如何实现的。</p>
<ol>
<li>build request(API参数配置)</li>
<li>executor</li>
<li>解析数据，返回T(需要的数据类型，下同)给上层</li>
</ol>
<p>Retrofit的版本</p>
<ol>
<li>通过注解配置API参数</li>
<li>CallAdapter(理解为 executor)</li>
<li>Converter(解析数据并转换为T)</li>
</ol>
<h3 id="创建Retrofit-对象"><a href="#创建Retrofit-对象" class="headerlink" title="创建Retrofit 对象"></a>创建Retrofit 对象</h3><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Retrofit</span> retrofit = <span class="function"><span class="keyword">new</span> <span class="title">Retrofit</span>.<span class="title">Builder</span>()</span></span><br><span class="line"><span class="function">            .<span class="title">client</span>(okHttpClient)</span></span><br><span class="line"><span class="function">            .<span class="title">baseUrl</span>("http://news-at.zhihu.com/")</span></span><br><span class="line"><span class="function">            .<span class="title">addConverterFactory</span>(gsonConverterFactory)</span></span><br><span class="line"><span class="function">            .<span class="title">addCallAdapterFactory</span>(rxJavaCallAdapterFactory)</span></span><br><span class="line"><span class="function">            .<span class="title">build</span>();</span></span><br></pre></td></tr></table></figure>
<h3 id="定义API"><a href="#定义API" class="headerlink" title="定义API"></a>定义API</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">ZhiHuApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">"api/4/news/latest"</span>)</span><br><span class="line">    Observable&lt;ZhiHu&gt; getStoriesInfo();</span><br><span class="line"></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">"api/4/news/before/&#123;date&#125;"</span>)</span><br><span class="line">    Observable&lt;ZhiHu&gt; getOldStoriesInfo(<span class="variable">@Path</span>(<span class="string">"date"</span>) String date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用到注解<code>@GET</code>、<code>@PATH</code></p>
<h3 id="获取API实例"><a href="#获取API实例" class="headerlink" title="获取API实例"></a>获取API实例</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ZhiHuApi zhiHuApi</span> = retrofit.create(ZhiHuApi.class);</span><br></pre></td></tr></table></figure>
<h4 id="create方法源码"><a href="#create方法源码" class="headerlink" title="create方法源码"></a>create方法源码</h4><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(<span class="string">"unchecked"</span>) // Single-<span class="class"><span class="keyword">interface</span> <span class="title">proxy</span> <span class="title">creation</span> <span class="title">guarded</span> <span class="title">by</span> <span class="title">parameter</span> <span class="title">safety</span>.</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T create(<span class="keyword">final</span> <span class="class"><span class="keyword">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">service</span>) &#123;</span></span><br><span class="line">  Utils.validateServiceInterface(service);</span><br><span class="line">  <span class="keyword">if</span> (validateEagerly) &#123;</span><br><span class="line">    eagerlyValidateMethods(service);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>&lt;?&gt;[] &#123; <span class="title">service</span> &#125;,</span></span><br><span class="line">      <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</span><br><span class="line"></span><br><span class="line">        @Override <span class="keyword">public</span> Object invoke(Object proxy, <span class="function"><span class="keyword">Method</span> <span class="title">method</span>, @<span class="title">Nullable</span> <span class="title">Object</span>[] <span class="title">args</span>)</span></span><br><span class="line">            throws Throwable &#123;</span><br><span class="line">          // <span class="keyword">If</span> the <span class="function"><span class="keyword">method</span> <span class="title">is</span> <span class="title">a</span> <span class="title">method</span> <span class="title">from</span> <span class="title">Object</span> <span class="title">then</span> <span class="title">defer</span> <span class="title">to</span> <span class="title">normal</span> <span class="title">invocation</span>.</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="function"><span class="keyword">method</span>.<span class="title">getDeclaringClass</span>(</span>) == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">method</span>.<span class="title">invoke</span>(</span>this, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (platform.isDefaultMethod(<span class="function"><span class="keyword">method</span>)) &#123;</span></span><br><span class="line">            <span class="keyword">return</span> platform.invokeDefaultMethod(<span class="function"><span class="keyword">method</span>, <span class="title">service</span>, <span class="title">proxy</span>, <span class="title">args</span>);</span></span><br><span class="line">          &#125;</span><br><span class="line">          ServiceMethod&lt;Object, Object&gt; serviceMethod =</span><br><span class="line">              (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">          OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</span><br><span class="line">          <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态代理？(不懂，逃…)</p>
<p>动态生成接口的实现类(动态)，并创建它的实例(代理)。代理把对接口的调用转发给<code>InvocationHandler</code>实例，在 InvocationHandler 的实现中，执行真正的逻辑。 </p>
<p>没错，下面就是 InvocationHandler 的源码啦</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>&lt;?&gt;[] &#123; <span class="title">service</span> &#125;,</span></span><br><span class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</span><br><span class="line"></span><br><span class="line">          @Override <span class="keyword">public</span> Object invoke(Object proxy, <span class="function"><span class="keyword">Method</span> <span class="title">method</span>, @<span class="title">Nullable</span> <span class="title">Object</span>[] <span class="title">args</span>)</span></span><br><span class="line">              throws Throwable &#123;</span><br><span class="line">            // <span class="keyword">If</span> the <span class="function"><span class="keyword">method</span> <span class="title">is</span> <span class="title">a</span> <span class="title">method</span> <span class="title">from</span> <span class="title">Object</span> <span class="title">then</span> <span class="title">defer</span> <span class="title">to</span> <span class="title">normal</span> <span class="title">invocation</span>.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="function"><span class="keyword">method</span>.<span class="title">getDeclaringClass</span>(</span>) == Object.class) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="function"><span class="keyword">method</span>.<span class="title">invoke</span>(</span>this, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(<span class="function"><span class="keyword">method</span>)) &#123;</span></span><br><span class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(<span class="function"><span class="keyword">method</span>, <span class="title">service</span>, <span class="title">proxy</span>, <span class="title">args</span>);</span></span><br><span class="line">            &#125;</span><br><span class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod =</span><br><span class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</span><br><span class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>为什么要用动态代理？因为对接口的所有方法的调用都会集中转发到  InvocationHandler 的 invoke 函数中，我们可以集中进行处理，更方便了。</p>
<h3 id="调用-API-方法"><a href="#调用-API-方法" class="headerlink" title="调用 API 方法"></a>调用 API 方法</h3><p>这里的代码和RxJava结合了</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Network.getZhiHuApi()</span><br><span class="line">            .getStoriesInfo()</span><br><span class="line">            .<span class="keyword">subscribeOn(Schedulers.io())</span></span><br><span class="line"><span class="keyword"> </span>           .observeOn(<span class="keyword">AndroidSchedulers.mainThread())</span></span><br><span class="line"><span class="keyword"> </span>           .<span class="keyword">subscribe(new </span>Consumer&lt;ZhiHu&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void accept(ZhiHu zhiHu) &#123;</span><br><span class="line">                    mSwipeRefreshLayout.setRefreshing(false)<span class="comment">;</span></span><br><span class="line">                    mStoriesBeanList = zhiHu.getStories()<span class="comment">;</span></span><br><span class="line">                    mZhiHuAdapter.setData(mStoriesBeanList)<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>在这里完成了<strong>HTTP请求</strong>，并将<strong>数据转化</strong>为需要的类型了。所以这里的很很很重要的地方。</p>
<p>那么是如何进行请求和转换的呢？</p>
<h4 id="进行HTTP请求-amp-数据转换-重要"><a href="#进行HTTP请求-amp-数据转换-重要" class="headerlink" title="进行HTTP请求&amp;数据转换(重要)"></a>进行HTTP请求&amp;数据转换(重要)</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServiceMethod&lt;Object, Object&gt; serviceMethod =</span><br><span class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</span><br><span class="line">            return serviceMethod.callAdapter.adapt(okHttpCall);</span><br></pre></td></tr></table></figure>
<p>这几行代码完成了<code>ServiceMethod</code>、<code>build OkHttpCall</code>、<code>CallAdapter adapt</code></p>
<h5 id="ServiceMethod-lt-R，T-gt"><a href="#ServiceMethod-lt-R，T-gt" class="headerlink" title="ServiceMethod&lt; R，T&gt;"></a>ServiceMethod&lt; R，T&gt;</h5><blockquote>
<p>/<em>* Adapts an invocation of an interface method into an HTTP call. </em>/</p>
</blockquote>
<p>ServiceMethod 作用在上面已经给出，翻译过来就是<strong>将接口方法转化为HTTP调用</strong></p>
<p>一个 ServiceMethod 对应着一个API接口方法，第一行中的 loadServiceMethod 方法的作用是用于加载 ServiceMethod</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ServiceMethod&lt;?, ?&gt; loadServiceMethod(<span class="function"><span class="keyword">Method</span> <span class="title">method</span>) &#123;</span></span><br><span class="line">    ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    synchronized (serviceMethodCache) &#123;</span><br><span class="line">      result = serviceMethodCache.get(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">      <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> ServiceMethod.Builder&lt;&gt;(this, <span class="function"><span class="keyword">method</span>).<span class="title">build</span>(</span>);</span><br><span class="line">        serviceMethodCache.put(<span class="function"><span class="keyword">method</span>, <span class="title">result</span>);</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在 loadServiceMethod 中你会发现它实现了缓存机制，同一个 Api 的同一个方法，只会被创建一次。</p>
<h5 id="ServiceMethod-的构造方法"><a href="#ServiceMethod-的构造方法" class="headerlink" title="ServiceMethod 的构造方法"></a>ServiceMethod 的构造方法</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ServiceMethod(Builder&lt;R, T&gt; builder) &#123;</span><br><span class="line">    <span class="keyword">this</span>.callFactory = builder.retrofit.callFactory();</span><br><span class="line">    <span class="keyword">this</span>.callAdapter = builder.callAdapter;</span><br><span class="line">    <span class="keyword">this</span>.baseUrl = builder.retrofit.baseUrl();</span><br><span class="line">    <span class="keyword">this</span>.responseConverter = builder.responseConverter;</span><br><span class="line">    <span class="keyword">this</span>.httpMethod = builder.httpMethod;</span><br><span class="line">    <span class="keyword">this</span>.relativeUrl = builder.relativeUrl;</span><br><span class="line">    <span class="keyword">this</span>.headers = builder.headers;</span><br><span class="line">    <span class="keyword">this</span>.contentType = builder.contentType;</span><br><span class="line">    <span class="keyword">this</span>.hasBody = builder.hasBody;</span><br><span class="line">    <span class="keyword">this</span>.isFormEncoded = builder.isFormEncoded;</span><br><span class="line">    <span class="keyword">this</span>.isMultipart = builder.isMultipart;</span><br><span class="line">    <span class="keyword">this</span>.parameterHandlers = builder.parameterHandlers;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>成员变量：callFactory 、callAdapter 、responseConverter 、parameterHandlers </p>
<ul>
<li>callFactory 负责创建 HTTP 请求，HTTP 请求被抽象为 okhttp3.call 类，表示随时可以执行 HTTP请求</li>
<li>callAdapter 将 retrofit2.Call&lt; T&gt; 转为 T (retrofit2.Call<t> 表示对一个 Retrofit 方法的调用)，这一个过程会执行一个 HTTP 请求，服务器返回数据(OkHttp3.call实现)，并且把数据转换为声明的 T 类型对象(Converter&lt;?, String&gt; 实现) </t></li>
<li>responseConverter (Converter<responsebody, t=""> 类型) 负责将服务器返回的数据转化为 T 类型的对象</responsebody,></li>
<li>parameterHandlers 负责解析API 定义时候每个方法的参数，并且在构造HTTP请求的时候设置参数</li>
</ul>
<h6 id="callFactory"><a href="#callFactory" class="headerlink" title="callFactory"></a>callFactory</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.callFactory = builder.retrofit.callFactory();</span><br></pre></td></tr></table></figure>
<p>我们在构建 retrofit 的时候就会指定一个 callFactory ，如果不指定，系统会默认设置一个  okhttp3.OkHttpClient</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * The factory used to create &#123;@linkplain okhttp3.Call OkHttp calls&#125; for sending a HTTP requests.</span><br><span class="line">   * Typically an<span class="built_in"> instance </span>of &#123;@link OkHttpClient&#125;.</span><br><span class="line">   */</span><br><span class="line"> <span class="keyword"> public</span> okhttp3.Call.Factory callFactory() &#123;</span><br><span class="line">   <span class="built_in"> return </span>callFactory;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h6 id="callAdapter"><a href="#callAdapter" class="headerlink" title="callAdapter"></a>callAdapter</h6><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CallAdapter&lt;T, R&gt; <span class="title">createCallAdapter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      Type returnType = method.getGenericReturnType();</span><br><span class="line">      <span class="keyword">if</span> (Utils.hasUnresolvableType(returnType)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(</span><br><span class="line">            <span class="string">"Method return type must not include a type variable or wildcard: %s"</span>, returnType);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Service methods cannot return void."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Annotation[] annotations = method.getAnnotations();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        <span class="keyword">return</span> (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; <span class="comment">// Wide exception range because factories are user code.</span></span><br><span class="line">        <span class="keyword">throw</span> methodError(e, <span class="string">"Unable to create call adapter for %s"</span>, returnType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>先进行一些检查，然后 <code>return (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</code> 由 retrofit 提供。</p>
<p>在 Retrofit 类内部，遍历<code>CallAdapter.Factory</code> 列表，由工厂提供，如果工厂没有提供需要的 callAdapter 就抛异常。</p>
<p>我们可以在构建 retrofit 时指定 callAdapter。</p>
<h6 id="responseConverter"><a href="#responseConverter" class="headerlink" title="responseConverter"></a>responseConverter</h6><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Converter&lt;ResponseBody, T&gt; createResponseConverter() &#123;</span><br><span class="line">      Annotation[] annotations = method.getAnnotations();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> retrofit.<span class="title">responseBodyConverter</span><span class="params">(responseType, annotations)</span></span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; <span class="comment">// Wide exception range because factories are user code.</span></span><br><span class="line">        <span class="keyword">throw</span> methodError(e, <span class="string">"Unable to create converter for %s"</span>, responseType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>responseConverter 由 retrofit 提供，看代码可以知道原理和 callAdapter 一致，先看工厂里面有没有，没有就报异常，同样可以再构建 retrofit 时指定。</p>
<h6 id="parameterHandlers"><a href="#parameterHandlers" class="headerlink" title="parameterHandlers"></a>parameterHandlers</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">private ParameterHandler&lt;?&gt; parseParameter(</span><br><span class="line">        int p,<span class="built_in"> Type </span>parameterType, Annotation[] annotations) &#123;</span><br><span class="line">      ParameterHandler&lt;?&gt; result = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</span><br><span class="line">        ParameterHandler&lt;?&gt; annotationAction = parseParameterAnnotation(</span><br><span class="line">            p, parameterType, annotations, annotation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (annotationAction == <span class="literal">null</span>) &#123;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">          throw parameterError(p, <span class="string">"Multiple Retrofit annotations found, only one allowed."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = annotationAction;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        throw parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>作用就是解析每个参数使用的注解类型（如 Path，Query，Field 等），对每种类型进行单独的处理。</p>
<p>构造 HTTP 请求时，我们传递的参数都是字符串，那 Retrofit 是如何把我们传递的各种参数都转换为 String 的呢？</p>
<p>还是由 Retrofit 类提供 converter</p>
<p>Converter.Factory 除了提供上一小节提到的 <code>responseBodyConverter</code>，还提供 <code>requestBodyConverter</code>和 <code>stringConverter</code></p>
<p>API 方法中除了 <code>@Body</code> 和 <code>@Part</code> 类型的参数，都利用 stringConverter 进行转换，而 @Body 和 @Part 类型的参数则利用 requestBodyConverter 进行转换。</p>
<p>这三种 converter 都是通过“询问”工厂列表进行提供，而工厂我们可以在构造 Retrofit 对象时进行添加。</p>
<p>三种工厂( okhttp3.Call.Factory，CallAdapter.Factory 和 Converter.Factory)</p>
<h3 id="OkHttpCall"><a href="#OkHttpCall" class="headerlink" title="OkHttpCall"></a>OkHttpCall</h3><p>OkHttpCall 实现了 retrofit2.Call，分别使用 execute() 和 equeue(Callback&lt; T&gt; callback)  <strong>执行同步或异步请求</strong></p>
<h3 id="同步请求"><a href="#同步请求" class="headerlink" title="同步请求"></a>同步请求</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@Override </span><br><span class="line"><span class="keyword">public</span> Response&lt;T&gt; execute() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  okhttp3.<span class="keyword">Call</span> <span class="keyword">call</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="comment">// 省略部分检查代码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">call</span> = rawCall;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">call</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">call</span> = rawCall = createRawCall();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException | RuntimeException e) &#123;</span><br><span class="line">        creationFailure = e;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> parseResponse(<span class="keyword">call</span>.execute());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> okhttp3.<span class="keyword">Call</span> createRawCall() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  Request request = serviceMethod.toRequest(args);</span><br><span class="line">  okhttp3.<span class="keyword">Call</span> <span class="keyword">call</span> = serviceMethod.callFactory.newCall(request);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">call</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">call</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response&lt;T&gt; parseResponse(okhttp3.Response rawResponse) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ResponseBody rawBody = rawResponse.body();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove the body's source (the only stateful object) so we can pass the response along.</span></span><br><span class="line">  rawResponse = rawResponse.newBuilder()</span><br><span class="line">      .body(<span class="keyword">new</span> NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> code = rawResponse.code();</span><br><span class="line">  <span class="keyword">if</span> (code &lt; <span class="number">200</span> || code &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">    <span class="comment">// ...返回错误</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (code == <span class="number">204</span> || code == <span class="number">205</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Response.success(<span class="keyword">null</span>, rawResponse);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    T body = serviceMethod.toResponse(catchingBody);</span><br><span class="line">    <span class="keyword">return</span> Response.success(body, rawResponse);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    <span class="comment">// ...异常处理</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要步骤</p>
<ol>
<li>创建 OkHttp3.Call</li>
<li>执行网络请求</li>
<li>解析服务器返回的数据</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> okhttp3.<span class="keyword">Call</span> createRawCall() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      Request request = serviceMethod.toRequest(args);</span><br><span class="line">      okhttp3.<span class="keyword">Call</span> <span class="keyword">call</span> = serviceMethod.callFactory.newCall(request);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">call</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">call</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 createRawCall 中调用 serviceMethod.toRequest(args) 来创建 request, args 就是来自于我们之前的 parameterHandlers </p>
<p><code>okhttp3.Call call = serviceMethod.callFactory.newCall(request);</code><br>创建 okhttp3.Call， callFactory在之前已经做过分析了。</p>
<p>利用 execute() 来执行网络请求，这个方法是阻塞的，执行完毕之后将返回收到的响应数据。</p>
<p>收到响应数据之后，先进行状态码的检查，通过检查之后调用 serviceMethod.toResponse(catchingBody) 来把响应数据转化为了需要的数据类型对象。在 toResponse 函数中，之前分析的 responseConverter 也派上了用场。</p>
<h3 id="异步请求"><a href="#异步请求" class="headerlink" title="异步请求"></a>异步请求</h3><p>异步的不同之处在于异步交给 okhttp3.Call#enqueue(Callback responseCallback) 来实现的，并在 callback 中调用 parseResponse 解析响应数据，并转发给传入的 callback。</p>
<h2 id="CallAdapter-数据转换"><a href="#CallAdapter-数据转换" class="headerlink" title="CallAdapter(数据转换)"></a>CallAdapter(数据转换)</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CallAdapter&lt;T, R&gt; <span class="title">createCallAdapter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      Type returnType = method.getGenericReturnType();</span><br><span class="line">      <span class="keyword">if</span> (Utils.hasUnresolvableType(returnType)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(</span><br><span class="line">            <span class="string">"Method return type must not include a type variable or wildcard: %s"</span>, returnType);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Service methods cannot return void."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Annotation[] annotations = method.getAnnotations();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        <span class="keyword">return</span> (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; <span class="comment">// Wide exception range because factories are user code.</span></span><br><span class="line">        <span class="keyword">throw</span> methodError(e, <span class="string">"Unable to create call adapter for %s"</span>, returnType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>作用就是将 retrofit2.Call R 转化为 T 。</p>
<h3 id="retrofit-的-adapter模块"><a href="#retrofit-的-adapter模块" class="headerlink" title="retrofit 的 adapter模块"></a>retrofit 的 adapter模块</h3><p>retrofit 内置了两个 adapterFactory</p>
<ul>
<li>DefaultCallAdapterFactory 直接将参数返回</li>
<li>ExecutorCallAdapterFactory 在异步调用时在指定的Eecutor上执行回调</li>
</ul>
<p>retrofit 子模块实现了更多的 adapterFactory</p>
<ul>
<li>GuavaCallAdapterFactory</li>
<li>Java8CallAdapterFactory</li>
<li>RxJavaCallAdapterFactory</li>
</ul>
<p>主要分析 RxJavaCallAdapterFactory </p>
<p>RxJavaCallAdapterFactory#get    方法中对返回值的类型进行了检查，只支持 rx.Single，rx.Completable 和 rx.Observable，这里主要关注对 rx.Observable 的支持。</p>
<p>RxJavaCallAdapterFactory#getCallAdapter  方法中对返回值的泛型类型进行了进一步检查</p>
<p>例如我们声明的返回值类型为 Observable&lt; List&lt; Repo&gt;&gt;，泛型类型就是 List&lt; Repo&gt;</p>
<p>这里对 retrofit2.Response 和 retrofit2.adapter.rxjava.Result 进行了特殊处理，有单独的 adapter 负责进行转换，其他所有类型都由 SimpleCallAdapter 负责转换。</p>
<p>SimpleCallAdapter#adapter</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; Observable&lt;R&gt; adapt(<span class="keyword">Call</span>&lt;R&gt; <span class="keyword">call</span>) &#123;</span><br><span class="line">  Observable&lt;R&gt; observable = Observable.create(<span class="keyword">new</span> CallOnSubscribe&lt;&gt;(<span class="keyword">call</span>))</span><br><span class="line">      .lift(OperatorMapResponseToBodyOrError.&lt;R&gt;instance());</span><br><span class="line">  <span class="keyword">if</span> (scheduler != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> observable.subscribeOn(scheduler);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建了一个 Observable，它的逻辑由 CallOnSubscribe 类实现，同时使用了一个 OperatorMapResponseToBodyOrError 操作符，用来把 retrofit2.Response 转为我们声明的类型，或者错误异常类型。</p>
<p>CallOnSubscribe#call</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; subscriber)</span> </span>&#123; <span class="comment">// Since Call is a one-shot type, clone it for each new subscriber. Call&lt;T&gt; call = originalCall.clone();</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap the call in a helper which handles both unsubscription and backpressure. RequestArbiter&lt;T&gt; requestArbiter = new RequestArbiter&lt;&gt;(call, subscriber);</span></span><br><span class="line">  subscriber.add(requestArbiter);</span><br><span class="line">  subscriber.setProducer(requestArbiter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>clone 了原来的 call，因为 okhttp3.Call 是只能用一次的，所以每次都是新 clone 一个进行网络请求；</li>
<li>创建了一个叫做 RequestArbiter 的 producer；</li>
<li>把这个 producer 设置给 subscriber</li>
</ol>
<p>大部分情况下 Subscriber 都是被动接受 Observable push 过来的数据，但要是 Observable 发得太快，Subscriber 处理不过来，那就有问题了，所以就有了一种 Subscriber 主动 pull 的机制，而这种机制就是通过 Producer 实现的。</p>
<p>给 Subscriber 设置 Producer 之后（通过 Subscriber#setProducer 方法），Subscriber 就会通过 Producer 向上游根据自己的能力请求数据（通过 Producer#request 方法），而 Producer 收到请求之后（通常都是 Observable 管理 Producer，所以“相当于”就是 Observable 收到了请求），再根据请求的量给 Subscriber 发数据。</p>
<p>(不就是rxjava 背压？？？)</p>
<p>RequestArbiter#request</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"n &lt; 0: "</span> + n);</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span>; <span class="comment">// Nothing to do when requesting 0.</span></span><br><span class="line">  <span class="keyword">if</span> (!compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) <span class="keyword">return</span>; <span class="comment">// Request was already triggered.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Response&lt;T&gt; response = call.execute();</span><br><span class="line">    <span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">      subscriber.onNext(response);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    Exceptions.throwIfFatal(t);</span><br><span class="line">    <span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">      subscriber.onError(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">    subscriber.onCompleted();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际干活的逻辑就是执行 call.execute()，并把返回值发送给下游。</p>
<p>OperatorMapResponseToBodyOrError#call</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; child) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Response&lt;T&gt;&gt;(child) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">        child.onNext(response.body());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        child.onError(<span class="keyword">new</span> HttpException(response));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      child.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">      child.onError(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 response.body() 并发送给下游。</p>
<p>这里，body() 返回的就是我们声明的泛型类型了</p>
<p>至于 Retrofit 是怎么把服务器返回的数据转为我们声明的类型的，那就看 responseBodyConverter，下面讲道。</p>
<p>执行流程</p>
<ol>
<li>Observable.subscribe，触发 API 调用的执行</li>
<li>CallOnSubscribe#call，clone call，创建并设置 producer</li>
<li>RequestArbiter#request，subscriber 被设置了 producer 之后最终调用 request，在 request 中发起请求，把结果发给下游</li>
<li>OperatorMapResponseToBodyOrError$1#onNext，把 response 的 body 发给下游</li>
<li>最终就到了 subscribe 传入的回调里面了</li>
</ol>
<h1 id="retrofit-converters-模块"><a href="#retrofit-converters-模块" class="headerlink" title="retrofit-converters 模块"></a>retrofit-converters 模块</h1><p> retrofit 内置 BuiltInConverters，只能处理 ResponseBody， RequestBody 和 String 类型的转化。</p>
<p> retrofit-converters 中的子模块则提供了 JSON，XML，ProtoBuf 等类型数据的转换功能，而且还有多种转换方式可以选择。这里主要关注 GsonConverterFactory</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, </span><br><span class="line">    Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">  TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GsonResponseBodyConverter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TypeAdapter&lt;T&gt; adapter;</span><br><span class="line"></span><br><span class="line">  GsonResponseBodyConverter(Gson gson, TypeAdapter&lt;T&gt; adapter) &#123;</span><br><span class="line">    <span class="keyword">this</span>.gson = gson;</span><br><span class="line">    <span class="keyword">this</span>.adapter = adapter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">T <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JsonReader jsonReader = gson.newJsonReader(value.charStream());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">return</span> adapter.<span class="title">read</span><span class="params">(jsonReader)</span></span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      value.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据目标类型，利用 Gson#getAdapter 获取相应的 adapter，转换时利用 Gson 的 API 即可.</p>
<p>至于Gson就又是一篇文章了。</p>
<p>参考<a href="https://blog.piasy.com/2016/06/25/Understand-Retrofit/" target="_blank" rel="noopener">大神piasy</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Retrofit2/" rel="tag"># Retrofit2</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/27/RxJava2-5/" rel="next" title="RxJava2(5)">
                <i class="fa fa-chevron-left"></i> RxJava2(5)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/28/OkHttp3-1/" rel="prev" title="OkHttp3(1)">
                OkHttp3(1) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNzc1OS8xNDI5MA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Wakaka</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
<br>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 
src="//music.163.com/outchain/player?type=2&id=428423168&auto=1&height=66"></iframe>

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#用途"><span class="nav-number">1.</span> <span class="nav-text">用途</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#发展历程"><span class="nav-number">2.</span> <span class="nav-text">发展历程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit"><span class="nav-number">3.</span> <span class="nav-text">Retrofit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#举个栗子"><span class="nav-number">3.1.</span> <span class="nav-text">举个栗子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析流程"><span class="nav-number">3.2.</span> <span class="nav-text">分析流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Retrofit-对象"><span class="nav-number">3.2.1.</span> <span class="nav-text">创建Retrofit 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义API"><span class="nav-number">3.2.2.</span> <span class="nav-text">定义API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取API实例"><span class="nav-number">3.2.3.</span> <span class="nav-text">获取API实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#create方法源码"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">create方法源码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用-API-方法"><span class="nav-number">3.2.4.</span> <span class="nav-text">调用 API 方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#进行HTTP请求-amp-数据转换-重要"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">进行HTTP请求&amp;数据转换(重要)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ServiceMethod-lt-R，T-gt"><span class="nav-number">3.2.4.1.1.</span> <span class="nav-text">ServiceMethod&lt; R，T&gt;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ServiceMethod-的构造方法"><span class="nav-number">3.2.4.1.2.</span> <span class="nav-text">ServiceMethod 的构造方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#callFactory"><span class="nav-number">3.2.4.1.2.1.</span> <span class="nav-text">callFactory</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#callAdapter"><span class="nav-number">3.2.4.1.2.2.</span> <span class="nav-text">callAdapter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#responseConverter"><span class="nav-number">3.2.4.1.2.3.</span> <span class="nav-text">responseConverter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#parameterHandlers"><span class="nav-number">3.2.4.1.2.4.</span> <span class="nav-text">parameterHandlers</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OkHttpCall"><span class="nav-number">3.2.5.</span> <span class="nav-text">OkHttpCall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步请求"><span class="nav-number">3.2.6.</span> <span class="nav-text">同步请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步请求"><span class="nav-number">3.2.7.</span> <span class="nav-text">异步请求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CallAdapter-数据转换"><span class="nav-number">3.3.</span> <span class="nav-text">CallAdapter(数据转换)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#retrofit-的-adapter模块"><span class="nav-number">3.3.1.</span> <span class="nav-text">retrofit 的 adapter模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#retrofit-converters-模块"><span class="nav-number">4.</span> <span class="nav-text">retrofit-converters 模块</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wakaka</span>

  
</div>

<div class="powered-by">
  <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
    本站访客数:<span id="busuanzi_value_site_uv"></span>
  </span>
</div>

<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
 

  <span class="post-meta-divider">|</span>



  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
